–†–∞–∑–±–µ—Ä—ë–º ¬´–ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏¬ª, –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ Kafka.

# 1) –ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å Kafka

**Topic** = ¬´–¥–æ—Ä–æ–≥–∞¬ª, **partition** = ¬´–ø–æ–ª–æ—Å–∞ –Ω–∞ —ç—Ç–æ–π –¥–æ—Ä–æ–≥–µ¬ª.
–°–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π *–ø–æ–ª–æ—Å—ã/partition* —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –ø–æ **offset** –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è append-only (_—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è_).
**–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞** –¥–µ–π—Å—Ç–≤—É–µ—Ç **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition**.

**Producer** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç partition:

* –µ—Å–ª–∏ –∑–∞–¥–∞–Ω **key** ‚Üí `partition = hash(key) % partitions` ‚Üí –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `key` –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–æ–π `partition` (–∏ –∑–Ω–∞—á–∏—Ç ‚Äî –≤ –ø–æ—Ä—è–¥–∫–µ);
```java
        int partitions = 10;
        int partition1 = hash("some_key_for_test") % partitions;    // hash() = 2033546674 -> partition1 = 4
        int partition2 = hash("good weather") % partitions;         // hash() = -1018673232 -> partition2 = -2
        int partition3 = hash("have a nice day") % partitions;      // hash() = -933326065 -> partition3 = -5  
  ```
* –µ—Å–ª–∏ `key` –Ω–µ—Ç ‚Üí –±—Ä–æ–∫–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç ¬´–ø–æ—á—Ç–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ¬ª (round-robin/sticky), **–Ω–æ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π –ø–æ—Ä—è–¥–∫–∞ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ partition**.

# 2) –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º) –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è

–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤ Kafka –∑–∞–¥–∞—ë—Ç **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ partition** –∏ **—á–∏—Å–ª–æ consumers –≤ –≥—Ä—É–ø–ø–µ**.

* –í –æ–¥–Ω–æ–π **consumer group** **–∫–∞–∂–¥–∞—è partition** –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ **—Ä–æ–≤–Ω–æ –æ–¥–Ω–æ–º—É** consumer –≤ –≥—Ä—É–ø–ø–µ.
* –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º = min(—á–∏—Å–ª–æ partitions, —á–∏—Å–ª–æ consumers –≤ –≥—Ä—É–ø–ø–µ)**.
* –ï—Å–ª–∏ consumers –±–æ–ª—å—à–µ, —á–µ–º partitions ‚Üí –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç.
* –ï—Å–ª–∏ consumers –º–µ–Ω—å—à–µ, —á–µ–º partitions ‚Üí –æ–¥–∏–Ω consumer —Ç—è–Ω–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ partitions (–Ω–æ **–≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π partition** —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ).

> –í—ã–≤–æ–¥: —Ö–æ—Ç–∏–º –±–æ–ª—å—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ ‚Äî **—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ partitions** –∏/–∏–ª–∏ **—á–∏—Å–ª–æ consumers** (–∏–Ω—Å—Ç–∞–Ω—Å—ã —Å–µ—Ä–≤–∏—Å–∞/–ø–æ—Ç–æ–∫–∏), –Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É = partitions.

## –ü–æ—Ä—è–¥–æ–∫ vs —Å–∫–æ—Ä–æ—Å—Ç—å

* –ù—É–∂–µ–Ω **—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ `userId`) ‚Üí –¥–µ–ª–∞–π `key = userId`. –¢–æ–≥–¥–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–Ω–æ–π partition ‚Üí –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è. 
–¶–µ–Ω–∞: –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–∞ ¬´–ø–æ–ª–æ—Å–∞¬ª –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–µ. `–æ–±—Ä–∞–±–æ—Ç–∫–∞ –µ–≥–æ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞`.
* –ù—É–∂–µ–Ω **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** ‚Üí –ø–æ–≤—ã—à–∞–π —á–∏—Å–ª–æ partitions. –ù–æ –ø–æ—Ä—è–¥–æ–∫ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ partitions **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**.

# 3) –†–µ–ø–ª–∏–∫–∞—Ü–∏—è, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

–£ partition –µ—Å—Ç—å **leader** –∏ **follower**-—Ä–µ–ø–ª–∏–∫–∏ (—Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è ‚â• 2‚Äì3). –ü–∏—Å–∞—Ç—å/—á–∏—Ç–∞—Ç—å ‚Äî —á–µ—Ä–µ–∑ `leader`.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–¥—å—é—Å–µ—Ä–∞ `acks=all` + ¬´`–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å`¬ª —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä—å/–¥—É–±–ª–∏–∫–∞—Ç–æ–≤; —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω—É–∂–Ω—ã –¥–ª—è ¬´exactly-once¬ª (_—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑_)(–¥–æ—Ä–æ–∂–µ –∏ —Å–ª–æ–∂–Ω–µ–µ).

# 4) Offsets –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏

`Offsets` ‚Äî ¬´–≥–¥–µ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å¬ª ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –±—Ä–æ–∫–µ—Ä–∞—Ö –≤ `__consumer_offsets` **–¥–ª—è –ø–∞—Ä—ã (group, partition)**.

–†–µ–∂–∏–º—ã:

* **At-most-once**: commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üí –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∫—Ä—ç—à–µ.
* **At-least-once** (`–¥–µ—Ñ–æ–ª—Ç`): –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí commit ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã **–ø–æ–≤—Ç–æ—Ä—ã** –ø—Ä–∏ —Ä–µ—Ç—Ä–∞—è—Ö (–¥–µ–ª–∞–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º).
* **Exactly-once**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (producer/Streams) ‚Üí –¥–æ—Ä–æ–∂–µ –ø–æ latency/—Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –Ω–æ –±–µ–∑ –¥—É–±–ª–µ–π.

# 5) Rebalance (–ø–æ—á–µ–º—É ¬´–¥–µ—Ä–≥–∞–µ—Ç—Å—è¬ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ)

–ö–æ–≥–¥–∞ –≤ –≥—Ä—É–ø–ø—É **–≤—Ö–æ–¥–∏—Ç/–≤—ã—Ö–æ–¥–∏—Ç** consumer, –º–µ–Ω—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ partitions, Kafka –¥–µ–ª–∞–µ—Ç **rebalance** ‚Äî –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç partitions.
–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: Range / RoundRobin / Sticky / CooperativeSticky (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–ø-—Å–≤–µ—Ç).

–ü—Ä–∞–∫—Ç–∏–∫–∞: –¥–µ—Ä–∂–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –±—ã—Å—Ç—Ä–æ–π (–∏–ª–∏ –≤—ã–Ω–æ—Å–∏ —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É –≤ worker-–ø—É–ª—ã), –∏–Ω–∞—á–µ —Ä–∏—Å–∫—É–µ—à—å —Å–ª–æ–≤–∏—Ç—å `max.poll.interval.ms` –∏ –≤—ã–ª–µ—Ç –∏–∑ –≥—Ä—É–ø–ø—ã ‚Üí –ª–∏—à–Ω–∏–π —Ä–µ–±–∞–ª–∞–Ω—Å.

# 6) –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —á–∏—Å–ª–æ partitions

–ü—Ä–∞–≤–∏–ª–æ: –ø–ª–∞–Ω–∏—Ä—É–π –ø–æ–¥ **–Ω—É–∂–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º —Å–µ–π—á–∞—Å + –∑–∞–ø–∞—Å**.

–ü—Ä–∏–º–µ—Ä: —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å \~2 000 msg/s –ø—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ \~200 msg/s –Ω–∞ –ø–æ—Ç–æ–∫.
–ù—É–∂–Ω–æ \~10 –ø–æ—Ç–æ–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚Üí —Å–¥–µ–ª–∞–π **–º–∏–Ω–∏–º—É–º 10 partitions** (–ª—É—á—à–µ 12‚Äì16 –ø–æ–¥ –∑–∞–ø–∞—Å –∏ –±—É–¥—É—â–∏–π —Ä–æ—Å—Ç).
–í–∞–∂–Ω–æ: **—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å partitions –º–æ–∂–Ω–æ**, –Ω–æ **—É–º–µ–Ω—å—à–∞—Ç—å** ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–ª—å–∑—è –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞.

# 7) Spring Kafka / Java: —á—Ç–æ –∑–Ω–∞—á–∏—Ç `concurrency`

–í Spring Kafka `@KafkaListener(concurrency = "N")` —Å–æ–∑–¥–∞—ë—Ç **N consumer-–ø–æ—Ç–æ–∫–æ–≤** (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞). –ù–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω **—á–∏—Å–ª–æ–º partitions**.

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–∞—Ä–∫–∞—Å:

```java
@EnableKafka
@Configuration
class KafkaConfig {

  @Bean
  ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory(
      ConsumerFactory<String, String> cf) {
    var f = new ConcurrentKafkaListenerContainerFactory<String, String>();
    f.setConsumerFactory(cf);
    // –ü–∞—Ä–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:
    // f.getContainerProperties().setAckMode(ContainerProperties.AckMode.RECORD); // commit –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
    // f.setCommonErrorHandler(new DefaultErrorHandler(recoverer, new FixedBackOff(1000L, 3L)));
    return f;
  }
}

@Service
class MyListener {

  // –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –ø–æ—Ç–æ–∫–æ–≤ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞
  @KafkaListener(topics = "orders", groupId = "billing", concurrency = "6")
  public void onMessage(ConsumerRecord<String, String> rec) {
    // –í–ê–ñ–ù–û: –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ ‚Üí –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º.
    // –ü–æ—Ä—è–¥–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ key —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–Ω–æ–π partition.
  }
}
```

**–í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å:**

* `concurrency` > `partitions` ‚Üí —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–æ–≤ –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—Ç—å.
* –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ** partitions, –Ω–æ **—Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏.
* –î–ª–∏–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞? –õ–∏–±–æ –ø–æ–¥–Ω–∏–º–∏ `max.poll.interval.ms`, –ª–∏–±–æ **–¥–µ–ª–µ–≥–∏—Ä—É–π** —Ä–∞–±–æ—Ç—É –≤ executor –∏ –∏—Å–ø–æ–ª—å–∑—É–π `pause()/resume()` partitions, –ª–∏–±–æ –≤–∫–ª—é—á–∞–π 
  –±–∞—Ç—á–∏ (`BatchListener` + `max.poll.records`) ‚Äî –∏ **–∫–æ–º–º–∏—Ç—å** –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.
* –î–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –ø–æ key ‚Äî **–Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition**.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∂—ë—Å—Ç–∫–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –∑–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–º (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å), –º–æ–∂–Ω–æ —Ç–∞–∫:

```java
@KafkaListener(groupId = "analytics",
  topicPartitions = {
    @TopicPartition(topic = "events", partitions = {"0","1","2"})
})
public void on(ConsumerRecord<String, String> rec) { ... }
```

# 8) –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö (–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã)

**Q: –ß—Ç–æ –¥–∞—ë—Ç partition?**
A: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–∑–æ–ª—è—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞: –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition.

**Q: –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞?**
A: `min(#partitions, #consumers –≤ –≥—Ä—É–ø–ø–µ)`.

**Q: –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?**
A: –ö–ª—é—á—É–π —Å–æ–æ–±—â–µ–Ω–∏—è `key = userId`, —á—Ç–æ–±—ã –≤—Å–µ –æ–Ω–∏ –ø–æ–ø–∞–ª–∏ –≤ –æ–¥–Ω—É partition.

**Q: –ü–æ—á–µ–º—É –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ consumers –Ω–∏—á–µ–≥–æ –Ω–µ —É—Å–∫–æ—Ä–∏–ª–æ—Å—å?**
A: –ü–æ—Ç–æ–º—É —á—Ç–æ —É–ø—ë—Ä–ª–∏—Å—å –≤ —á–∏—Å–ª–æ partitions; –ª–∏—à–Ω–∏–µ consumers –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç.

**Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è offsets?**
A: –í —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Ç–æ–ø–∏–∫–µ `__consumer_offsets`, –ø–æ (group, partition).

**Q: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π –ø—Ä–∏ at-least-once?**
A: –°–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, upsert –ø–æ –∫–ª—é—á—É, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ eventId).

**Q: –ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ–±–∞–ª–∞–Ω—Å –∏ –∫–∞–∫ –µ–≥–æ —Å–º—è–≥—á–∏—Ç—å?**
A: –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –≥—Ä—É–ø–ø–µ; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sticky/cooperative assignor, –∏–∑–±–µ–≥–∞—Ç—å –¥–æ–ª–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫/stop-the-world.

**Q: –ö–∞–∫ –ø–æ–¥–æ–±—Ä–∞—Ç—å #partitions?**
A: –û—Ç —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞/–ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ–π—á–∞—Å + –∑–∞–ø–∞—Å (—É—á—Ç–∏, —É–º–µ–Ω—å—à–∞—Ç—å –Ω–µ–ª—å–∑—è).

---

üî• –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ **Kafka + Spring Kafka**, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ –æ—Å–≤–µ–∂–∏—Ç—å –∑–Ω–∞–Ω–∏—è.

---

# üìù Kafka + Spring Kafka —à–ø–∞—Ä–≥–∞–ª–∫–∞

---

## 1. –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã

* **Topic** ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π.
* **Partition** ‚Äî ¬´–ø–æ–ª–æ—Å–∞¬ª –≤–Ω—É—Ç—Ä–∏ —Ç–æ–ø–∏–∫–∞, —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ offset.
* **Consumer group** ‚Äî –≥—Ä—É–ø–ø–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —á–∏—Ç–∞—é—Ç —Ç–æ–ø–∏–∫ (–∫–∞–∂–¥—ã–π partition ‚Üí —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É consumer –≤ –≥—Ä—É–ø–ø–µ).
* **Offset** ‚Äî –ø–æ–∑–∏—Ü–∏—è –≤ partition.

---

## 2. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (concurrency)

* –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω:

```
  concurrency = min(#partitions, #consumers –≤ group)
```

* –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition —Å–æ–æ–±—â–µ–Ω–∏—è **—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É**.
* –ü–æ—Ä—è–¥–æ–∫ –º–µ–∂–¥—É partition **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**.

üëâ –ß—Ç–æ–±—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –ø–æ –ø–æ—Ä—è–¥–∫—É ‚Üí `key = userId`.

---

## 3. Producer (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```yaml
spring:
  kafka:
    producer:
      bootstrap-servers: localhost:9092
      acks: all        # –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫
      retries: 3       # —Ä–µ—Ç—Ä–∞–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      properties:
        enable.idempotence: true   # –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–Ω–µ—Ç –¥—É–±–ª–µ–π)
        max.in.flight.requests.per.connection: 1
```

–ö–æ–¥:

```java
@Service
class Producer {
  private final KafkaTemplate<String, String> template;

  public Producer(KafkaTemplate<String, String> template) {
    this.template = template;
  }

  public void send(String key, String value) {
    template.send("orders", key, value);
  }
}
```

---

## 4. Consumer (—á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)

–ù–∞—Å—Ç—Ä–æ–π–∫–∏:

```yaml
spring:
  kafka:
    consumer:
      bootstrap-servers: localhost:9092
      group-id: billing-service
      enable-auto-commit: false
      auto-offset-reset: earliest
      max-poll-records: 50  # –∑–∞ —Ä–∞–∑ —á–∏—Ç–∞–µ–º –¥–æ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
```

–ö–æ–¥:

```java
@Service
class MyListener {

  // concurrency = –∫–æ–ª-–≤–æ consumer-–ø–æ—Ç–æ–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  @KafkaListener(topics = "orders", concurrency = "4")
  public void onMessage(ConsumerRecord<String, String> rec) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    System.out.println("Got: " + rec.value());
  }
}
```

---

## 5. Commit offsets

* **At-most-once**: commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–±—ã—Å—Ç—Ä–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è).
* **At-least-once (–¥–µ—Ñ–æ–ª—Ç)**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí commit (–Ω–∞–¥—ë–∂–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏).
* **Exactly-once**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ—Ä–æ–∂–µ, —Ä–µ–¥–∫–æ –Ω–∞–¥–æ).

–ü—Ä–∏–º–µ—Ä —Ä—É—á–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞:

```java
@KafkaListener(topics = "orders")
public void listen(ConsumerRecord<String, String> rec, Acknowledgment ack) {
    try {
        process(rec.value());
        ack.acknowledge(); // –∫–æ–º–º–∏—Ç offset
    } catch (Exception e) {
        // –Ω–µ –∫–æ–º–º–∏—Ç–∏–º, —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è
    }
}
```

---

## 6. –û—à–∏–±–∫–∏ –∏ —Ä–µ—Ç—Ä–∞–∏

* **DefaultErrorHandler** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ + —Ä–µ—Ç—Ä–∞–∏.
* **DLT (Dead Letter Topic)** ‚Äî —Ç–æ–ø–∏–∫ –¥–ª—è ¬´–ø–ª–æ—Ö–∏—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π.

–ü—Ä–∏–º–µ—Ä:

```java
@Bean
public DefaultErrorHandler errorHandler(KafkaTemplate<Object, Object> template) {
    var recoverer = new DeadLetterPublishingRecoverer(template);
    var backOff = new FixedBackOff(1000L, 3L); // 3 —Ä–µ—Ç—Ä–∞—è —Å –ø–∞—É–∑–æ–π 1—Å
    return new DefaultErrorHandler(recoverer, backOff);
}
```

---

## 7. –ü–∞—É–∑–∞ / —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ (pause / resume)

–ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—è–∂—ë–ª–∞—è:

```java
@KafkaListener(id = "orders", topics = "orders")
public void listen(ConsumerRecord<String, String> rec, 
                   Acknowledgment ack, 
                   Consumer<?,?> consumer) {
    consumer.pause(Collections.singleton(new TopicPartition("orders", rec.partition())));
    try {
        process(rec.value());
        ack.acknowledge();
    } finally {
        consumer.resume(Collections.singleton(new TopicPartition("orders", rec.partition())));
    }
}
```

---

## 8. –ü–æ–ª–µ–∑–Ω—ã–µ –ø—Ä–æ–ø—Å—ã

* `max.poll.records` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑ —Ç—è–Ω–µ–º.
* `max.poll.interval.ms` ‚Äî –º–∞–∫—Å. –≤—Ä–µ–º—è –º–µ–∂–¥—É poll() (—É–≤–µ–ª–∏—á–∏–≤–∞–π –ø—Ä–∏ –¥–æ–ª–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ).
* `session.timeout.ms` ‚Äî –≤—Ä–µ–º—è, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–µ consumer —Å—á–∏—Ç–∞–µ—Ç—Å—è –º—ë—Ä—Ç–≤—ã–º.
* `fetch.min.bytes` / `fetch.max.wait.ms` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º/–∑–∞–¥–µ—Ä–∂–∫–æ–π –ø–∞–∫–µ—Ç–æ–≤.

---

## 9. –ß–∞—Å—Ç—ã–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

* **Q: –ß—Ç–æ –¥–∞—ë—Ç partition?**
  –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ (–≤–Ω—É—Ç—Ä–∏ partition).
* **Q: –ü–æ—á–µ–º—É –ª–∏—à–Ω–∏–µ consumers –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç?**
  –ü–æ—Ç–æ–º—É —á—Ç–æ consumers > partitions.
* **Q: –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?**
  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å key ‚Üí –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ key –≤ –æ–¥–Ω–æ–π partition.
* **Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è offsets?**
  –í —Ç–æ–ø–∏–∫–µ `__consumer_offsets` (–ø–æ –≥—Ä—É–ø–ø–µ –∏ partition).
* **Q: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π?**
  –°–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ eventId).
* **Q: –ß—Ç–æ —Ç–∞–∫–æ–µ rebalance?**
  –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –º–µ–∂–¥—É consumers (–ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤).

---

üìå **–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ**:

* –ë–æ–ª—å—à–µ partitions ‚Üí –≤—ã—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ –ø–æ—Ä—è–¥–æ–∫.
* –ü–æ—Ä—è–¥–æ–∫ –ø–æ `key` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π `partition`.
* –î—É–±–ª–∏ ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –¥–µ–ª–∞–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º.

---

–•–æ—á–µ—à—å, —è —Å–æ–±–µ—Ä—É —ç—Ç–æ –≤ **–æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É-¬´—à–ø–∞—Ä–≥–∞–ª–∫—É¬ª** (–≤ –≤–∏–¥–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤/—Å—Ä–∞–≤–Ω–µ–Ω–∏–π), —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç –ø—Ä–æ–±–µ–∂–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∏–Ω—Ç–µ—Ä–≤—å—é?


---

–°—É–ø–µ—Ä üöÄ –í–æ—Ç —Ç–µ–±–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è **—Ç–∞–±–ª–∏—Ü–∞-—à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ Kafka** ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–±–µ–∂–∞—Ç—å –≥–ª–∞–∑–∞–º–∏ –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ–º:

---

# üìù Kafka —à–ø–∞—Ä–≥–∞–ª–∫–∞ (–¥–ª—è —Å–æ–±–µ—Å–æ–≤)

| –¢–µ–º–∞                    | –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã                                                                                                                                                                              |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Topic**               | –õ–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π                                                                                                                                                                    |
| **Partition**           | ¬´–ü–æ–ª–æ—Å–∞¬ª –≤–Ω—É—Ç—Ä–∏ —Ç–æ–ø–∏–∫–∞, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è**                                                                                                                  |
| **Offset**              | –ü–æ–∑–∏—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ partition                                                                                                                                                                 |
| **Consumer Group**      | –°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ç–æ–ø–∏–∫–∞; **–æ–¥–Ω–∞ partition ‚Üí —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É consumer –≤ –≥—Ä—É–ø–ø–µ**                                                                                                                |
| **–ú–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**   | `min(#partitions, #consumers –≤ –≥—Ä—É–ø–ø–µ)`                                                                                                                                                       |
| **Producer (–æ—Ç–ø—Ä–∞–≤–∫–∞)** | - `acks=all` (–Ω–∞–¥—ë–∂–Ω–æ)<br>- `enable.idempotence=true` (–Ω–µ—Ç –¥—É–±–ª–µ–π)<br>- –∫–ª—é—á (`key`) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç partition                                                                                     |
| **Consumer (—á—Ç–µ–Ω–∏–µ)**   | - `enable-auto-commit=false` (–ª—É—á—à–µ —Ä—É—á–Ω–æ–π commit)<br>- `max.poll.records` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑<br>- `max.poll.interval.ms` ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏ –¥–æ–ª–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ                            |
| **Commit offset**       | - *at-most-once*: commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ—Ç–µ—Ä–∏)<br>- *at-least-once*: commit –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥—É–±–ª–∏ –≤–æ–∑–º–æ–∂–Ω—ã)<br>- *exactly-once*: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ—Ä–æ–≥–æ, —Ä–µ–¥–∫–æ)                                  |
| **–†–µ—Ç—Ä–∞–∏ –∏ –æ—à–∏–±–∫–∏**     | `DefaultErrorHandler` + `DeadLetterPublishingRecoverer` ‚Üí DLT (—Ç–æ–ø–∏–∫ –¥–ª—è ¬´–ø–ª–æ—Ö–∏—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π)                                                                                                  |
| **–ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π**   | - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π partition<br>- –ß—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Üí `key = userId`                                                                                                |
| **Rebalance**           | –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–∏—Å–ª–∞ consumers/partitions                                                                                                                         |
| **–ö–∞–∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å**  | - –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å partitions<br>- –ü–æ–¥–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à–µ consumers (–Ω–æ –Ω–µ –±–æ–ª—å—à–µ partitions)                                                                                                            |
| **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã** | - –î–æ–ª–≥–∏–µ –∑–∞–¥–∞—á–∏: –ª–∏–±–æ —É–≤–µ–ª–∏—á—å `max.poll.interval.ms`, –ª–∏–±–æ –≤—ã–Ω–µ—Å–∏ –≤ worker pool<br>- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–ª–∞–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (eventId, upsert)<br>- –ü–∞—Ä—Ç–∏—Ü–∏–π –ª—É—á—à–µ –∑–∞–¥–∞—Ç—å —Å –∑–∞–ø–∞—Å–æ–º (—É–º–µ–Ω—å—à–∏—Ç—å –Ω–µ–ª—å–∑—è) |

---

‚ö° **–°–≤–µ—Ä—Ö–∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Å–æ–±–µ—Å–∞**:

* *–ü–æ—á–µ–º—É UUID —É–Ω–∏–∫–∞–ª–µ–Ω?* ‚Üí 2¬π¬≤‚Å∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏ ‚âà 0.
* *–ß—Ç–æ –¥–∞—ë—Ç partition?* ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏.
* *–ö–∞–∫–æ–π –º–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º?* ‚Üí –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —á–∏—Å–ª–æ–º partitions.
* *–ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ userId?* ‚Üí key=userId.
* *–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –¥—É–±–ª—è–º–∏?* ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞.
* *–ß—Ç–æ —Ç–∞–∫–æ–µ rebalance?* ‚Üí –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã.

---


–û—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å üëç
–†–∞–∑–±–µ—Ä—ë–º –ø–æ —à–∞–≥–∞–º.

---

## üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ `max.poll.interval.ms`

* –≠—Ç–æ **consumer-side –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –∏–∑ Kafka).
* –û–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É –¥–≤—É–º—è –≤—ã–∑–æ–≤–∞–º–∏ `poll()`**.
* –ï—Å–ª–∏ consumer **—Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `poll()` —Å–Ω–æ–≤–∞, –±—Ä–æ–∫–µ—Ä —Å—á–∏—Ç–∞–µ—Ç –µ–≥–æ **¬´—É–ø–∞–≤—à–∏–º¬ª** –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç **rebalance** ‚Üí partition —É—Ö–æ–¥–∏—Ç –¥—Ä—É–≥–æ–º—É consumer.

üëâ –¢–æ –µ—Å—Ç—å, **–µ—Å–ª–∏ —É —Ç–µ–±—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ª–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 —Å–µ–∫, 1 –º–∏–Ω), –Ω–∞–¥–æ —É–≤–µ–ª–∏—á–∏—Ç—å `max.poll.interval.ms`, —á—Ç–æ–±—ã consumer –Ω–µ –≤—ã–ª–µ—Ç–∞–ª –∏–∑ –≥—Ä—É–ø–ø—ã.

---

## üîπ –î–ª—è –∫–æ–≥–æ —ç—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è

–≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä **Kafka consumer**, –∑–Ω–∞—á–∏—Ç:

* –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ö** (consumers).
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Spring Kafka ‚Üí `application.yaml` –∏–ª–∏ `ConsumerFactory`).

---

## üîπ –ö–∞–∫ –∑–∞–¥–∞—Ç—å –≤ `application.yaml`

–î–∞, –º–æ–∂–Ω–æ! –í Spring Boot –≤—Å—ë –ø—Ä–æ—Å—Ç–æ:

```yaml
spring:
  kafka:
    consumer:
      properties:
        max.poll.interval.ms: 600000   # 10 –º–∏–Ω—É—Ç
```

–∏–ª–∏ —á–µ—Ä–µ–∑ Java Config:

```java
props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 600000);
```

---

## üîπ –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å

* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `max.poll.interval.ms` **–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è heartbeat**.
  –ß—Ç–æ–±—ã consumer –Ω–µ –≤—ã–ø–∞–ª –∏–∑ –≥—Ä—É–ø–ø—ã, –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–ª–∞—Ç—å heartbeat (—á–µ—Ä–µ–∑ `heartbeat.interval.ms`) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ.
* –ù–æ –µ—Å–ª–∏ —Ç—ã ¬´–∑–∞–≤–∏—Å–Ω–µ—à—å¬ª –¥–æ–ª—å—à–µ, —á–µ–º `max.poll.interval.ms` –±–µ–∑ –≤—ã–∑–æ–≤–∞ `poll()` ‚Üí consumer —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞—Å—Ç—Ä—è–≤—à–∏–º, –∏–¥—ë—Ç —Ä–µ–±–∞–ª–∞–Ω—Å.

---

## üîπ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç

1. –ï—Å–ª–∏ —É —Ç–µ–±—è **–¥–æ–ª–≥–∏–µ —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Üí –ø–æ–¥–Ω–∏–º–∏ `max.poll.interval.ms` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 5‚Äì10 –º–∏–Ω—É—Ç).
2. –ï—Å–ª–∏ –º–æ–∂–Ω–æ ‚Äî **–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—É** –Ω–∞ —á–∞–Ω–∫–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –±—ã—Å—Ç—Ä–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –¥—ë—Ä–≥–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä.
3. –ï—â—ë –ª—É—á—à–µ: –≤—ã–Ω–µ—Å–∏ —Ç—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ (worker pool), –∞ consumer —Ç–æ–ª—å–∫–æ **–±—ã—Å—Ç—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç offset**.

---

üìå –ù–∞ —Å–æ–±–µ—Å–µ —Ö–æ—Ä–æ—à–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–∞–∫:

> "`max.poll.interval.ms` ‚Äî —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ consumer, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É poll(). –ï—Å–ª–∏ consumer –¥–æ–ª–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç poll, –æ–Ω –≤—ã–ø–∞–¥–µ—Ç –∏–∑ –≥—Ä—É–ø–ø—ã. –í Spring Boot —ç—Ç–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤ `application.yaml` —á–µ—Ä–µ–∑ `spring.kafka.consumer.properties.max.poll.interval.ms`. –û–±—ã—á–Ω–æ –µ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ö –∏–ª–∏ –≤—ã–Ω–æ—Å—è—Ç —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤."

---

–•–æ—á–µ—à—å, —è –µ—â—ë –ø–æ–∫–∞–∂—É –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –≥–¥–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã **`max.poll.interval.ms`** –∏ **`max.poll.records`**, —á—Ç–æ–±—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ç—è–∂—ë–ª–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ?


---

–û—Ç–ª–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å üëç
–≠—Ç–∏ –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–∞–∫ —Ä–∞–∑ —á–∞—Å—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –≤–º–µ—Å—Ç–µ:

* **`max.poll.records`** ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π consumer –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞ –æ–¥–∏–Ω `poll()`.
* **`max.poll.interval.ms`** ‚Äî —Å–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ç–æ–π –ø–∞—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

–ò–¥–µ—è: –µ—Å–ª–∏ —É —Ç–µ–±—è —Ç—è–∂—ë–ª–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ 2‚Äì3 —Å–µ–∫—É–Ω–¥—ã), —Ç–æ:

* —É–º–µ–Ω—å—à–∏—Ç—å `max.poll.records`, —á—Ç–æ–±—ã –∑–∞ –æ–¥–∏–Ω `poll()` –Ω–µ —Ç—è–Ω—É—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ;
* —É–≤–µ–ª–∏—á–∏—Ç—å `max.poll.interval.ms`, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É –∏ –Ω–µ –≤—ã–ª–µ—Ç–µ—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã.

---

## üîπ –ü—Ä–∏–º–µ—Ä –≤ `application.yaml`

```yaml
spring:
  kafka:
    consumer:
      bootstrap-servers: localhost:9092
      group-id: heavy-worker
      enable-auto-commit: false
      auto-offset-reset: earliest
      properties:
        max.poll.records: 10         # –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 300000 # –¥–∞—ë–º –¥–æ 5 –º–∏–Ω—É—Ç –Ω–∞ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É
```

---

## üîπ Java-–∫–æ–Ω—Ñ–∏–≥ —Å ConsumerFactory

```java
@Configuration
@EnableKafka
public class KafkaConfig {

    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "heavy-worker");
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

        // üîë –Ω–∞—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 10);         // –º–µ–Ω—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 300000); // 5 –º–∏–Ω—É—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—á–∫–∏

        return new DefaultKafkaConsumerFactory<>(props, new StringDeserializer(), new StringDeserializer());
    }

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory());
        return factory;
    }
}
```

---

## üîπ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

–î–æ–ø—É—Å—Ç–∏–º:

* –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è \~2 —Å–µ–∫,
* –≤ –ø–∞—á–∫–µ (`max.poll.records = 10`) –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π,
* –∑–Ω–∞—á–∏—Ç worst-case –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ = \~20 —Å–µ–∫.

–ú—ã –∑–∞–¥–∞–ª–∏ `max.poll.interval.ms = 300000` (5 –º–∏–Ω—É—Ç), —á—Ç–æ —Å –∑–∞–ø–∞—Å–æ–º –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π.

–ò –±—Ä–æ–∫–µ—Ä –Ω–µ –≤—ã–∫–∏–Ω–µ—Ç consumer –∏–∑ –≥—Ä—É–ø–ø—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω ¬´–∑–∞–¥–µ—Ä–∂–∞–ª—Å—è¬ª –Ω–∞ 20‚Äì30 —Å–µ–∫—É–Ω–¥.

---

üëâ –ù–∞ —Å–æ–±–µ—Å–µ —Ö–æ—Ä–æ—à–æ —Å–∫–∞–∑–∞—Ç—å —Ç–∞–∫:

> "–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å consumer –ø–æ–¥ —Ç—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –º—ã —É–º–µ–Ω—å—à–∞–µ–º `max.poll.records`, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑, –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º `max.poll.interval.ms`, —á—Ç–æ–±—ã consumer —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É –∏ –Ω–µ –≤—ã–ø–∞—Å—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã. –í Spring Boot —ç—Ç–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –ø—Ä—è–º–æ –≤ `application.yaml`."

---

–•–æ—á–µ—à—å, —è —Å–æ–±–µ—Ä—É —Ç–µ–±–µ **—Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤** (–∫–æ—Ä–æ—Ç–∫–∏–µ/–¥–æ–ª–≥–∏–µ –∑–∞–¥–∞—á–∏, –±–∞—Ç—á–∏, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—É–ª–µ –ø–æ—Ç–æ–∫–æ–≤), —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –∏–º–µ—Ç—å –≥–æ—Ç–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã?

---

–û—Ç–ª–∏—á–Ω–æ! üöÄ
–¢–æ–≥–¥–∞ –¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º **—à–ø–∞—Ä–≥–∞–ª–∫—É —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kafka consumer –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**.

---

# üìù –†–µ—Ü–µ–ø—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Kafka Consumer

---

## 1. ‚ö° –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ª–µ–≥–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

* –¶–µ–ª—å: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞.
* –°–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è <100 –º—Å.

```yaml
spring:
  kafka:
    consumer:
      group-id: fast-worker
      enable-auto-commit: true      # –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–∫–æ–º–º–∏—Ç
      properties:
        max.poll.records: 500       # –ø–æ–±–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 300000 # –¥–µ—Ñ–æ–ª—Ç (5 –º–∏–Ω) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
```

## üëâ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –º–µ—Ç—Ä–∏–∫, –ª—ë–≥–∫–∏—Ö –∏–≤–µ–Ω—Ç–æ–≤.

## 2. üõ† –¢—è–∂—ë–ª–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (CPU / DB –æ–ø–µ—Ä–∞—Ü–∏–∏)

* –¶–µ–ª—å: –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å consumer, –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É.
* –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–µ–∫—É–Ω–¥—ã.

```yaml
spring:
  kafka:
    consumer:
      group-id: heavy-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 10        # –º–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 600000 # 10 –º–∏–Ω—É—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—á–∫–∏
```

## üëâ –•–æ—Ä–æ—à–æ –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å—á—ë—Ç –æ—Ç—á—ë—Ç–æ–≤, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã).

## 3. üì¶ –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (bulk)

* –¶–µ–ª—å: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î / API.

```yaml
spring:
  kafka:
    listener:
      type: batch  # –≤–∫–ª—é—á–∞–µ–º –±–∞—Ç—á-–ª–∏—Å—Ç–µ–Ω–µ—Ä
    consumer:
      group-id: batch-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 100       # –±–µ—Ä—ë–º –ø–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
        max.poll.interval.ms: 300000
```

–ö–æ–¥:

```java
@KafkaListener(topics = "events", containerFactory = "batchFactory")
public void listen(List<ConsumerRecord<String, String>> records) {
    // –ø–∞—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    bulkInsert(records.stream().map(ConsumerRecord::value).toList());
}
```

üëâ –ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –≤—ã–≥–æ–¥–Ω–µ–µ –ø–∏—Å–∞—Ç—å –≤ –ë–î/–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å API **—Å—Ä–∞–∑—É –ø–∞—á–∫–æ–π**.

---

## 4. üîÑ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (worker pool)

* –¶–µ–ª—å: consumer –±—ã—Å—Ç—Ä–æ ¬´–≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç¬ª —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ —Ç—è–∂—ë–ª–∞—è —Ä–∞–±–æ—Ç–∞ —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤.

```yaml
spring:
  kafka:
    consumer:
      group-id: async-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 50
        max.poll.interval.ms: 600000
```

–ö–æ–¥:

```java
@Service
class AsyncListener {

    private final ExecutorService pool = Executors.newFixedThreadPool(10);

    @KafkaListener(topics = "orders", concurrency = "3")
    public void listen(ConsumerRecord<String, String> rec, Acknowledgment ack) {
        pool.submit(() -> {
            try {
                process(rec.value()); // —Ç—è–∂—ë–ª–∞—è —Ä–∞–±–æ—Ç–∞
                ack.acknowledge();
            } catch (Exception e) {
                // retry / dlt
            }
        });
    }
}
```

üëâ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–¥–∞—á, –≥–¥–µ –Ω—É–∂–Ω–æ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å throughput.

---

## 5. ‚ùå –†–∞–±–æ—Ç–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –∏ DLT

* –¶–µ–ª—å: –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫.

```java
@Bean
public DefaultErrorHandler errorHandler(KafkaTemplate<Object, Object> template) {
    var recoverer = new DeadLetterPublishingRecoverer(template);
    var backOff = new FixedBackOff(2000L, 3L); // 3 —Ä–µ—Ç—Ä–∞—è —Å –ø–∞—É–∑–æ–π 2 —Å–µ–∫
    return new DefaultErrorHandler(recoverer, backOff);
}
```

üëâ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –≤ **Dead Letter Topic** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `orders.DLT`).

---

# üìå –ö—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–æ–º

1. **–õ—ë–≥–∫–∏–µ –∑–∞–¥–∞—á–∏** ‚Üí `max.poll.records` –ø–æ–±–æ–ª—å—à–µ, –º–æ–∂–Ω–æ –∞–≤—Ç–æ-–∫–æ–º–º–∏—Ç.
2. **–¢—è–∂—ë–ª—ã–µ –∑–∞–¥–∞—á–∏** ‚Üí `max.poll.records` —É–º–µ–Ω—å—à–∏—Ç—å, `max.poll.interval.ms` —É–≤–µ–ª–∏—á–∏—Ç—å.
3. **–ë–∞—Ç—á–∏** ‚Üí `listener.type=batch` + `max.poll.records` –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏.
4. **Worker pool** ‚Üí consumer –±—ã—Å—Ç—Ä–æ —Ç—è–Ω–µ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏.
5. **–û—à–∏–±–∫–∏** ‚Üí DefaultErrorHandler + DLT, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.

---

üî• –≠—Ç–æ –ø—Ä—è–º –≥–æ—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –ª—é–±–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–æ ¬´–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å consumer –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏¬ª.

–•–æ—á–µ—à—å, —è –æ—Ñ–æ—Ä–º–ª—é —ç—Ç–æ –≤ **.docx —à–ø–∞—Ä–≥–∞–ª–∫—É** (—Ç–∞–±–ª–∏—Ü—ã + –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞), —á—Ç–æ–±—ã —É–¥–æ–±–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –ø–æ–¥ —Ä—É–∫–æ–π –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ?

---

