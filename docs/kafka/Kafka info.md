–†–∞–∑–±–µ—Ä—ë–º ¬´–ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏¬ª, –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ Kafka.

# 1) –ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å Kafka
## –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: –†–∞–∑–¥–µ–ª—ã (Partitions) ‚Äî —ç—Ç–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ "–¥–æ—Ä–æ–∂–∫–∏"

**Topic** = ¬´–¥–æ—Ä–æ–≥–∞¬ª, **partition** = ¬´–ø–æ–ª–æ—Å–∞ –Ω–∞ —ç—Ç–æ–π –¥–æ—Ä–æ–≥–µ¬ª.
–°–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π *–ø–æ–ª–æ—Å—ã/partition* —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –ø–æ **offset** –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è append-only (_—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è_).
**–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞** –¥–µ–π—Å—Ç–≤—É–µ—Ç **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition**.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ Kafka —Ç–æ–ø–∏–∫ ‚Äî —ç—Ç–æ –Ω–µ –æ–¥–Ω–∞ –æ—á–µ—Ä–µ–¥—å, –∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π (—Ä–∞–∑–¥–µ–ª–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

–ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–¥–µ–ª–æ–≤ ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (consumer'–æ–≤) –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —Ç–µ–º –≤—ã—à–µ –æ–±—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ù–æ –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞.

**Producer** –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç partition:

* –µ—Å–ª–∏ –∑–∞–¥–∞–Ω **key** ‚Üí `partition = hash(key) % partitions` ‚Üí –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `key` –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–æ–π `partition` (–∏ –∑–Ω–∞—á–∏—Ç ‚Äî –≤ –ø–æ—Ä—è–¥–∫–µ);
```java
        int partitions = 10;
        int partition1 = hash("some_key_for_test") % partitions;    // hash() = 2033546674 -> partition1 = 4
        int partition2 = hash("good weather") % partitions;         // hash() = -1018673232 -> partition2 = -2
        int partition3 = hash("have a nice day") % partitions;      // hash() = -933326065 -> partition3 = -5  
  ```
* –µ—Å–ª–∏ `key` –Ω–µ—Ç ‚Üí –±—Ä–æ–∫–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç ¬´–ø–æ—á—Ç–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ¬ª (round-robin/sticky), **–Ω–æ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π –ø–æ—Ä—è–¥–∫–∞ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ partition**.

# 2) –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º) –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è

–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤ Kafka –∑–∞–¥–∞—ë—Ç **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ partition** –∏ **—á–∏—Å–ª–æ consumers –≤ –≥—Ä—É–ø–ø–µ**. –ü–∞—Ä–∞–º–µ—Ç—Ä concurrency –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ª–∏—Å–µ–Ω–µ—Ä–∞.

* –í –æ–¥–Ω–æ–π **consumer group** **–∫–∞–∂–¥–∞—è partition** –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ **—Ä–æ–≤–Ω–æ –æ–¥–Ω–æ–º—É** consumer –≤ –≥—Ä—É–ø–ø–µ.
* –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º = min(—á–∏—Å–ª–æ partitions, —á–∏—Å–ª–æ consumers –≤ –≥—Ä—É–ø–ø–µ)**.
* –ï—Å–ª–∏ consumers –±–æ–ª—å—à–µ, —á–µ–º partitions ‚Üí –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç.
* –ï—Å–ª–∏ consumers –º–µ–Ω—å—à–µ, —á–µ–º partitions ‚Üí –æ–¥–∏–Ω consumer —Ç—è–Ω–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ partitions (–Ω–æ **–≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π partition** —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ).

> –í—ã–≤–æ–¥: —Ö–æ—Ç–∏–º –±–æ–ª—å—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ ‚Äî **—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ partitions** –∏/–∏–ª–∏ **—á–∏—Å–ª–æ consumers** (–∏–Ω—Å—Ç–∞–Ω—Å—ã —Å–µ—Ä–≤–∏—Å–∞/–ø–æ—Ç–æ–∫–∏), –Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É = partitions. 
> –¢.–µ. –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å concurrency = N_partitions

## –ü–æ—Ä—è–¥–æ–∫ vs —Å–∫–æ—Ä–æ—Å—Ç—å

* –ù—É–∂–µ–Ω **—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ `userId`) ‚Üí –¥–µ–ª–∞–π `key = userId`. –¢–æ–≥–¥–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–Ω–æ–π partition ‚Üí –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è. 
–¶–µ–Ω–∞: –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–∞ ¬´–ø–æ–ª–æ—Å–∞¬ª –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–µ. `–æ–±—Ä–∞–±–æ—Ç–∫–∞ –µ–≥–æ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞`.
* –ù—É–∂–µ–Ω **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** ‚Üí –ø–æ–≤—ã—à–∞–π —á–∏—Å–ª–æ partitions. –ù–æ –ø–æ—Ä—è–¥–æ–∫ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ partitions **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**.

# 3) –†–µ–ø–ª–∏–∫–∞—Ü–∏—è, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

–£ partition –µ—Å—Ç—å **leader** –∏ **follower**-—Ä–µ–ø–ª–∏–∫–∏ (—Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è ‚â• 2‚Äì3). –ü–∏—Å–∞—Ç—å/—á–∏—Ç–∞—Ç—å ‚Äî —á–µ—Ä–µ–∑ `leader`.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–¥—å—é—Å–µ—Ä–∞ `acks=all` + ¬´`–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å`¬ª —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä—å/–¥—É–±–ª–∏–∫–∞—Ç–æ–≤; —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω—É–∂–Ω—ã –¥–ª—è ¬´exactly-once¬ª (_—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑_)(–¥–æ—Ä–æ–∂–µ –∏ —Å–ª–æ–∂–Ω–µ–µ).

# 4) Offsets –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏

`Offsets` ‚Äî ¬´–≥–¥–µ –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å¬ª ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ –±—Ä–æ–∫–µ—Ä–∞—Ö –≤ `__consumer_offsets` **–¥–ª—è –ø–∞—Ä—ã (group, partition)**.

–†–µ–∂–∏–º—ã:

* **At-most-once**: commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üí –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∫—Ä—ç—à–µ.
* **At-least-once** (`–¥–µ—Ñ–æ–ª—Ç`): –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí commit ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã **–ø–æ–≤—Ç–æ—Ä—ã** –ø—Ä–∏ —Ä–µ—Ç—Ä–∞—è—Ö (–¥–µ–ª–∞–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º).
* **Exactly-once**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (producer/Streams) ‚Üí –¥–æ—Ä–æ–∂–µ –ø–æ latency/—Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –Ω–æ –±–µ–∑ –¥—É–±–ª–µ–π.


---

–ü—Ä–∏–≤–µ—Ç! –û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–º –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π –Ω–∞ –±—ç–∫–µ–Ω–¥-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞. –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç—É –¥–∏–ª–µ–º–º—É Kafka –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–≥–ª—è–¥–Ω–æ, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –Ω–∞ Kotlin.

### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: –†–∞–∑–¥–µ–ª—ã (Partitions) ‚Äî —ç—Ç–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ "–¥–æ—Ä–æ–∂–∫–∏"

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ Kafka —Ç–æ–ø–∏–∫ ‚Äî —ç—Ç–æ –Ω–µ –æ–¥–Ω–∞ –æ—á–µ—Ä–µ–¥—å, –∞ **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π (—Ä–∞–∑–¥–µ–ª–æ–≤)**, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.

–ß–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–¥–µ–ª–æ–≤ ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (consumer'–æ–≤) –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —Ç–µ–º –≤—ã—à–µ –æ–±—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ù–æ –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π **–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞**.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–ø–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–∞–∂–µ–Ω)

**–°–∏—Ç—É–∞—Ü–∏—è:** –£ –Ω–∞—Å –µ—Å—Ç—å —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ –ø–æ —Ä–µ–∫–ª–∞–º–µ. –ö–∞–∂–¥—ã–π –∫–ª–∏–∫ ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —Å–æ–±—ã—Ç–∏–µ. –ù–µ–≤–∞–∂–Ω–æ, –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –≥–ª–∞–≤–Ω–æ–µ ‚Äî —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ.

**–†–µ—à–µ–Ω–∏–µ:** –ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è **–±–µ–∑ –∫–ª—é—á–∞ (key = null)**. –ö–∞—Ñ–∫–∞ –±—É–¥–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏—Ö –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ (round-robin), –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É.

```kotlin
// Producer (–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)
fun sendClicks(clickEvents: List<ClickEvent>) {
    clickEvents.forEach { event ->
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –∫–ª—é—á–∞ -> –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
        val producerRecord = ProducerRecord<String, ClickEvent>("clicks_topic", null, event)
        kafkaProducer.send(producerRecord)
    }
}

// Consumer (–ü–æ–ª—É—á–∞—Ç–µ–ª—å)
// –ú—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Consumer Group)
// –ö–∞–∂–¥—ã–π consumer –∑–∞–±–µ—Ä–µ—Ç —Å–µ–±–µ 1-2 —Ä–∞–∑–¥–µ–ª–∞ –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è
@KafkaListener(topics = ["clicks_topic"], groupId = "click-processor")
fun processClick(click: ClickEvent) {
    // –ë—ã—Å—Ç—Ä–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    analyticsService.registerClick(click)
    // –ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–¥–µ—Å—å –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
*   –°–æ–æ–±—â–µ–Ω–∏—è `ClickEvent-1`, `ClickEvent-2`, `ClickEvent-3` –ª–µ—Ç—è—Ç –≤ —Ç–æ–ø–∏–∫.
*   –û–Ω–∏ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, Partition-0, Partition-1, Partition-0).
*   –¢—Ä–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–µ—Å–ª–∏ partitions=3) –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç –∏—Ö **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ**.
*   –°–æ–æ–±—â–µ–Ω–∏–µ ‚Ññ3 –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–∞–Ω—å—à–µ ‚Ññ2 ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

**–ò—Ç–æ–≥:** **–í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å**, –Ω–æ **–Ω—É–ª–µ–≤—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞**.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ (—Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∏–∂–µ)

**–°–∏—Ç—É–∞—Ü–∏—è:** –£ –Ω–∞—Å –µ—Å—Ç—å —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `+100`, `-50`, `+200`. **–ö—Ä–∞–π–Ω–µ –≤–∞–∂–Ω–æ** –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ **–∏–º–µ–Ω–Ω–æ –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ**. –ï—Å–ª–∏ `-50` –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ `+100`, –±–∞–ª–∞–Ω—Å —É–π–¥–µ—Ç –≤ –º–∏–Ω—É—Å ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **–∫–ª—é—á (key)**. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥—É—Ç –≤ **–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–∞–∑–¥–µ–ª**.

```kotlin
// Producer (–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å)
fun sendBalanceUpdates(userId: String, updates: List<BalanceUpdate>) {
    updates.forEach { update ->
        // –ö–ª—é—á = userId -> –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ
        val producerRecord = ProducerRecord<String, BalanceUpdate>("balance_updates_topic", userId, update)
        kafkaProducer.send(producerRecord)
    }
}

// Consumer (–ü–æ–ª—É—á–∞—Ç–µ–ª—å)
@KafkaListener(topics = ["balance_updates_topic"], groupId = "balance-processor")
fun processBalanceUpdate(update: BalanceUpdate, @Header(KafkaHeaders.RECEIVED_KEY) userId: String) {

    // –í–∞–∂–Ω–æ! –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –û–î–ù–û–ì–û userId –±—É–¥–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π.
    // –î–ª—è —Ä–∞–∑–Ω—ã—Ö userId - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π.
    walletService.applyBalanceUpdate(userId, update)
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
*   –°–æ–æ–±—â–µ–Ω–∏—è `{userId: 123, update: +100}`, `{userId: 123, update: -50}`, `{userId: 456, update: +200}` –ª–µ—Ç—è—Ç –≤ —Ç–æ–ø–∏–∫.
*   Kafka –≤—ã—á–∏—Å–ª—è–µ—Ç —Ö—ç—à –æ—Ç –∫–ª—é—á–∞ `123` –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º –∏–¥—É—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `Partition-1`.
*   –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è `userId=456` –≤—Å–µ–≥–¥–∞ –ø–æ–π–¥—É—Ç –≤ –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª (–¥–æ–ø—É—Å—Ç–∏–º, `Partition-2`).
*   **–í–Ω—É—Ç—Ä–∏ `Partition-1` –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω:** `+100` –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–¥–µ—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ `-50`.
*   –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –¥–ª—è `Partition-1` –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –¥–ª—è `Partition-2` —Ä–∞–±–æ—Ç–∞—é—Ç **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 456 –Ω–µ –∂–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123.

**–ò—Ç–æ–≥:** **–ü–æ—Ä—è–¥–æ–∫ –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ (userId) –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω**, –Ω–æ **—Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞** —Å–∫–æ—Ä–æ—Å—Ç—å—é –æ–¥–Ω–æ–≥–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è (–æ–¥–Ω–æ–π "–¥–æ—Ä–æ–∂–∫–∏").

---

### –ê–Ω–∞–ª–∏–∑ "–¶–µ–Ω—ã" –∑–∞ –ø–æ—Ä—è–¥–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —É–ø–æ–º—è–Ω—É–ª

> –¶–µ–Ω–∞: –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω–∞ ¬´–ø–æ–ª–æ—Å–∞¬ª –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `X` **–≤—ã–Ω—É–∂–¥–µ–Ω—ã** –∏–¥—Ç–∏ –ø–æ –æ–¥–Ω–æ–π "–¥–æ—Ä–æ–∂–∫–µ" (partition). –°–∫–æ–ª—å–∫–æ –±—ã —É –≤–∞—Å –Ω–∏ –±—ã–ª–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (10, 20, 100), –æ–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `X`.

*   **–ë–µ–∑ –∫–ª—é—á–∞:** 1000 —Å–æ–±—ã—Ç–∏–π –æ—Ç 1000 —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Üí 10 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π ‚Üí ~100 —Å–æ–±—ã—Ç–∏–π –≤ —Å–µ–∫—É–Ω–¥—É (—É—Å–ª–æ–≤–Ω–æ).
*   **–° –∫–ª—é—á–æ–º:** 1000 —Å–æ–±—ã—Ç–∏–π –æ—Ç 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç.–µ. –ø–æ 100 —Å–æ–±—ã—Ç–∏–π –Ω–∞ –∫–∞–∂–¥–æ–≥–æ) ‚Üí 10 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π ‚Üí **–º–∞–∫—Å–∏–º—É–º 10 —Å–æ–±—ã—Ç–∏–π –≤ —Å–µ–∫—É–Ω–¥—É** (—Ç.–∫. —Å–æ–±—ã—Ç–∏—è –¥–ª—è *–æ–¥–Ω–æ–≥–æ* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å).

–ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–π –æ–±—ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–ª–æ–Ω –ú–∞—Å–∫ –ø–∏—à–µ—Ç —Ç–≤–∏—Ç—ã), –æ–Ω –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å "–±—É—Ç—ã–ª–æ—á–Ω—ã–º –≥–æ—Ä–ª—ã—à–∫–æ–º" –¥–ª—è –≤—Å–µ–≥–æ —Ç–æ–ø–∏–∫–∞, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–ª—å–∑—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å.

### –ö–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (—á–∞—Å—Ç–æ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö)

**–í–æ–ø—Ä–æ—Å:** "–ê —á—Ç–æ –µ—Å–ª–∏ –Ω–∞–º –Ω—É–∂–µ–Ω –∏ –ø–æ—Ä—è–¥–æ–∫, –∏ –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –æ–¥–Ω–æ–≥–æ "–≥–æ—Ä—è—á–µ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?"

**–û—Ç–≤–µ—Ç:** –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∏–∑–∞–π–Ω —Å–∏—Å—Ç–µ–º—ã. –ù–∞–ø—Ä–∏–º–µ—Ä:
1.  **–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–æ–≤** (—Å–∫–∞–∂–µ–º, —Å 10 –¥–æ 100) –¥–ª—è —Ç–æ–ø–∏–∫–∞. –≠—Ç–æ –Ω–µ —É—Å–∫–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–æ –ª—É—á—à–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –º–µ–∂–¥—É –º–Ω–æ–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
2.  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ü–µ–ø—Ü–∏—é "—Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" –≤–Ω—É—Ç—Ä–∏ –∫–ª—é—á–∞.** –í–º–µ—Å—Ç–æ `userId` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `"${userId}_${segment}"`, –≥–¥–µ `segment` ‚Äî —ç—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, `orderId` –∏–ª–∏ –Ω–æ–º–µ—Ä —Å–µ—Å—Å–∏–∏. –≠—Ç–æ —Ä–∞–∑–æ–±—å–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤, –≥–¥–µ –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–∞.
  *   *–î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º —ç—Ç–æ –ø–ª–æ—Ö–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü ‚Äî –æ—Ç–ª–∏—á–Ω–æ–µ.*

```kotlin
// –ü—Ä–∏–º–µ—Ä: –ú—ã —Ö–æ—Ç–∏–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏,
// –Ω–æ —Ä–∞–∑–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
val sessionId = "session_${uuid}"
val compositeKey = "${userId}_$sessionId"

val producerRecord = ProducerRecord<String, PageViewEvent>("page_views_topic", compositeKey, event)
```

### –ò—Ç–æ–≥ –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã

| –ü–æ–¥—Ö–æ–¥ | –ö–ª—é—á (Key) | –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º | –ü–æ—Ä—è–¥–æ–∫ | –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| :--- | :--- | :--- | :--- | :--- |
| **–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å** | `null` (Round-Robin) | **–í—ã—Å–æ–∫–∏–π** (–ø–æ —Ä–∞–∑–¥–µ–ª—É) | **–ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π** | –õ–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏, –∫–ª–∏–∫–∏ |
| **–°—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫** | `userId` (–∏–ª–∏ –¥—Ä. ID) | **–£–º–µ—Ä–µ–Ω–Ω—ã–π** (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é) | **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–ª—é—á–∞** | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∞—É–¥–∏—Ç |
| **–ö–æ–º–ø—Ä–æ–º–∏—Å—Å** | `userId_sessionId` | **–í—ã—Å–æ–∫–∏–π** (–ø–æ —Å–µ—Å—Å–∏–∏) | **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Å–µ—Å—Å–∏–∏** | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ |

–ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å **–∫–æ–º–ø—Ä–æ–º–∏—Å—Å (trade-off)** –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –ø–æ—Ä—è–¥–∫–æ–º –∏ –º–æ–∂–µ—à—å –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä —Ç–æ–≥–æ –∏–ª–∏ –∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á—É.

---

–µ—â–µ —Ä–∞–∑–æ–∫ —Ö–æ—á—É —Å–ø—Ä–æ—Å–∏—Ç—å, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å: –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –∑–∞–¥–∞—á–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç–æ–ø–∏–∫ —Ä–∞–∑–±–∏—Ç –Ω–∞ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π, –∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–µ–Ω —Å–≤–æ–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å?

–û—Ç–ª–∏—á–Ω—ã–π –∏ –æ—á–µ–Ω—å –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í—ã –Ω–µ–º–Ω–æ–≥–æ –∑–∞–ø—É—Ç–∞–ª–∏—Å—å –≤ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è.

**–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:** –ù–µ—Ç, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–Ω–µ –Ω—É–∂–µ–Ω** —Å–≤–æ–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å (consumer instance). –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ **–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–Ω–∞ —Å–≤–æ—è "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å" (–ø–∞—Ä—Ç–∏—Ü–∏—è)**, –∏ –≤—Å–µ —ç—Ç–∏ –æ—á–µ—Ä–µ–¥–∏ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ–≥–æ **–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏** –∏–∑ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã.

---

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ: –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ vs. –ü–∞—Ä—Ç–∏—Ü–∏–∏

1.  **–ü–∞—Ä—Ç–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ –µ–¥–∏–Ω–∏—Ü—ã –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞.** –í –≤–∞—à–µ–º —Ç–æ–ø–∏–∫–µ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, Kafka –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ **1000 —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.

2.  **–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ (Consumers) –≤ –≥—Ä—É–ø–ø–µ ‚Äî —ç—Ç–æ "—Ä–∞–±–æ—á–∏–µ".** –ì—Ä—É–ø–ø–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (`consumer group`) ‚Äî —ç—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –ø–æ–¥–æ–≤ –≤ Kubernetes), –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ, —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å –∏–∑ —Ç–æ–ø–∏–∫–∞.

3.  **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:** Kafka –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Ç–æ–ø–∏–∫–∞ –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏ –≤ –≥—Ä—É–ø–ø–µ.
  *   –ï—Å–ª–∏ —É –≤–∞—Å **1000 –ø–∞—Ä—Ç–∏—Ü–∏–π** –∏ **10 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π** –≤ –≥—Ä—É–ø–ø–µ, —Ç–æ –∫–∞–∂–¥–æ–º—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—é –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ **100 –ø–∞—Ä—Ç–∏—Ü–∏–π**.
  *   –ï—Å–ª–∏ –≤—ã –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç–µ—Å—å –¥–æ **1000 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π**, —Ç–æ –∫–∞–∂–¥—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Ä–æ–≤–Ω–æ **–ø–æ 1 –ø–∞—Ä—Ç–∏—Ü–∏–∏**.
  *   –ï—Å–ª–∏ —É –≤–∞—Å **1000 –ø–∞—Ä—Ç–∏—Ü–∏–π** –∏ –≤—Å–µ–≥–æ **1 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å**, —Ç–æ —ç—Ç–æ—Ç –±–µ–¥–Ω—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –±—É–¥–µ—Ç –≤—ã–Ω—É–∂–¥–µ–Ω —á–∏—Ç–∞—Ç—å —Å–æ –≤—Å–µ—Ö **1000 –ø–∞—Ä—Ç–∏—Ü–∏–π** —Å–∞–º.

---

### –ü—Ä–∏–º–µ—Ä —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (–Ω–∞ Kotlin)

**–¶–µ–ª—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `Alice` (`userId=123`) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è: `+$100` -> `-$50` -> `+$200`.

**–†–µ—à–µ–Ω–∏–µ:**

1.  **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å (Producer)** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è `userId` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞.

```kotlin
// Producer.kt
fun sendTransaction(userId: String, transaction: Transaction) {
    // –ö–ª—é—á = userId. –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ø–∞–¥—É—Ç –≤ –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—Ü–∏—é.
    val record = ProducerRecord<String, Transaction>(
        "financial-transactions", // topic
        userId,                   // key -> –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é
        transaction               // value
    )
    kafkaProducer.send(record)
}

// –ü—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏:
sendTransaction("123", Transaction(amount = 100, type = "DEPOSIT")) // –ü–æ–ø–∞–¥–µ—Ç –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é X
sendTransaction("456", Transaction(amount = 999, type = "DEPOSIT")) // –ü–æ–ø–∞–¥–µ—Ç –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é Y
sendTransaction("123", Transaction(amount = 50, type = "WITHDRAW")) // –ü–æ–ø–∞–¥–µ—Ç –≤ —Ç—É –∂–µ –ø–∞—Ä—Ç–∏—Ü–∏—é X!
```

2.  **–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ (Consumers)** —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –≥—Ä—É–ø–ø–µ. –ò—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–Ω–µ —Ä–∞–≤–Ω–æ** –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

```kotlin
// Consumer.kt
@KafkaListener(
    topics = ["financial-transactions"],
    groupId = "transaction-processors", // <- –í–∞–∂–Ω–æ! –í—Å–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å —ç—Ç–∏–º groupId —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ.
    concurrency = "10" // –≠—Ç–æ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–æ–∑–¥–∞—Å—Ç 10 –ø–æ—Ç–æ–∫–æ–≤-–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π.
)
fun processTransaction(
    transaction: Transaction,
    @Header(KafkaHeaders.RECEIVED_KEY) userId: String,
    @Header(KafkaHeaders.RECEIVED_PARTITION) partition: Int
) {
    logger.info("Processing transaction for user $userId from partition $partition: $transaction")
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    // –î–ª—è userId=123 –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –µ–≥–æ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —ç—Ç–∏–º –º–µ—Ç–æ–¥–æ–º
    // –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏.
    accountService.process(userId, transaction)
}
```

### –ù–∞–≥–ª—è–¥–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≥–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —Ç–æ–ø–∏–∫ ‚Äî —ç—Ç–æ –æ–≥—Ä–æ–º–Ω—ã–π —Å—Ç–æ–ª —Å 1000 –∫–æ—Ä–∑–∏–Ω (–ø–∞—Ä—Ç–∏—Ü–∏–π). –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –∫–æ—Ä–∑–∏–Ω–∞–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `userId` (–∫–ª—é—á).

*   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `Alice` (`userId=123`) –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç, –¥–æ–ø—É—Å—Ç–∏–º, –≤ **–∫–æ—Ä–∑–∏–Ω—É ‚Ññ42**.
*   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `Bob` (`userId=456`) –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç, –¥–æ–ø—É—Å—Ç–∏–º, –≤ **–∫–æ—Ä–∑–∏–Ω—É ‚Ññ777**.

–¢–µ–ø–µ—Ä—å –ø—Ä–∏—Ö–æ–¥–∏—Ç **–≥—Ä—É–ø–ø–∞ —Ä–∞–±–æ—á–∏—Ö** (–≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å `groupId="transaction-processors"`). –î–æ–ø—É—Å—Ç–∏–º, –∏—Ö **10 —á–µ–ª–æ–≤–µ–∫**.

*   –ö–∞–∂–¥—ã–π —Ä–∞–±–æ—á–∏–π –ø–æ–¥—Ö–æ–¥–∏—Ç –∏ –±–µ—Ä–µ—Ç —Å–µ–±–µ –ø–æ **100 –∫–æ—Ä–∑–∏–Ω**.
*   **–†–∞–±–æ—á–∏–π ‚Ññ3** –≤–∑—è–ª —Å–µ–±–µ –∫–æ—Ä–∑–∏–Ω—ã —Å ‚Ññ400 –ø–æ ‚Ññ500, –≤–∫–ª—é—á–∞—è **–∫–æ—Ä–∑–∏–Ω—É ‚Ññ42** (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `Alice`).
*   **–†–∞–±–æ—á–∏–π ‚Ññ8** –≤–∑—è–ª —Å–µ–±–µ –∫–æ—Ä–∑–∏–Ω—ã —Å ‚Ññ750 –ø–æ ‚Ññ850, –≤–∫–ª—é—á–∞—è **–∫–æ—Ä–∑–∏–Ω—É ‚Ññ777** (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `Bob`).

**–ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç:**

*   **–ì–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞:** –†–∞–±–æ—á–∏–π ‚Ññ3 –±—É–¥–µ—Ç –≤—ã–Ω–∏–º–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã ‚Ññ42 —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É. `+$100` –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Ä–∞–Ω—å—à–µ `-$50`. –ü–æ—Ä—è–¥–æ–∫ –¥–ª—è `Alice` —Å–æ—Ö—Ä–∞–Ω–µ–Ω.
*   **–í—ã—Å–æ–∫–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º:** –†–∞–±–æ—á–∏–π ‚Ññ3 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `Alice`, –∞ —Ä–∞–±–æ—á–∏–π ‚Ññ8 –≤ —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `Bob`. –í—Å–µ–≥–æ 10 —Ä–∞–±–æ—á–∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç 1000 –∫–æ—Ä–∑–∏–Ω. –ú—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏.
*   **–ú–∞c—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç, –º—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ä–∞–±–æ—á–∏—Ö (—É–≤–µ–ª–∏—á–∏—Ç—å `concurrency` –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è). Kafka –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–æ—Ä–∑–∏–Ω—ã –º–µ–∂–¥—É –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–∞–±–æ—á–∏—Ö. –ï—Å–ª–∏ –æ–¥–∏–Ω —Ä–∞–±–æ—á–∏–π "–∑–∞–±–æ–ª–µ–µ—Ç" (—ç–∫–∑–µ–º–ø–ª—è—Ä —É–ø–∞–ª), –µ–≥–æ –∫–æ—Ä–∑–∏–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–±–µ—Ä—É—Ç –¥—Ä—É–≥–∏–µ —Ä–∞–±–æ—á–∏–µ.

### –ò—Ç–æ–≥:

*   –í–∞–º **–ù–ï** –Ω—É–∂–Ω–æ 1000 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –Ω–∞ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π –∏ —Ç–µ–º –±–æ–ª–µ–µ –Ω–µ –Ω—É–∂–µ–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*   –í–∞–º –Ω—É–∂–Ω–æ **–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –≤ –≥—Ä—É–ø–ø–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10-100), —á—Ç–æ–±—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –≤—Å–µ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π.
*   **–ö–ª—é—á (`userId`)** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ø–∞–¥—É—Ç –≤ –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—Ü–∏—é.
*   **–ú–µ—Ö–∞–Ω–∏–∑–º consumer group** –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –∑–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º –≤ –≥—Ä—É–ø–ø–µ, —á—Ç–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∏ **—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫** –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏, –∏ **–≤—ã—Å–æ–∫–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã –≤ —Ü–µ–ª–æ–º.

---

–ø–æ–Ω—è–ª, –Ω–æ –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞. –ò–∑ –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—à–µ –º—ã –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–ª–∏, —á—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–ª—é—á—É userId=123 —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç —É–ª–æ–∂–µ–Ω—ã –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é ‚Ññ42. –ê –º–æ–∂–µ—Ç –∂–µ –±—ã—Ç—å —Ç–∞–∫, —á—Ç–æ –∫–∞–∫–æ–π-—Ç–æ userId=some_id —Ç–æ–∂–µ –∫–∞–∫-—Ç–æ –ø–æ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∏ –ø–æ–ø–∞–¥–µ—Ç –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é ‚Ññ42. –ö–∞–∫ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø–æ–π–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å?


–ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í—ã –ø–æ–ø–∞–ª–∏ –≤ —Å–∞–º—É—é —Å—É—Ç—å. **–î–∞, –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç!** –ò —ç—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Ä–µ–∂–∏–º –ö–∞—Ñ–∫–∏.

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ—Ç –∫–µ–π—Å –ø–æ–¥—Ä–æ–±–Ω–æ.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –∫–ª—é—á—É?

–ö–∞—Ñ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ö—ç—à-–∞–ª–≥–æ—Ä–∏—Ç–º** (–æ–±—ã—á–Ω–æ murmur2) –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –∫–ª—é—á—É.

1.  **–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ö—ç—à** –æ—Ç –∫–ª—é—á–∞ (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ `userId`).
2.  **–•—ç—à –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ –Ω–æ–º–µ—Ä –ø–∞—Ä—Ç–∏—Ü–∏–∏** –ø–æ —Ñ–æ—Ä–º—É–ª–µ: `partition = hash(key) % total_partitions`.

**–°–ª–µ–¥—Å—Ç–≤–∏–µ:** –†–∞–∑–Ω—ã—Ö –∫–ª—é—á–µ–π –º–Ω–æ–≥–æ (–º–∏–ª–ª–∏–æ–Ω—ã `userId`), –∞ –ø–∞—Ä—Ç–∏—Ü–∏–πÊúâÈôê–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000). –ü–æ **–ø—Ä–∞–≤–∏–ª—É –î–∏—Ä–∏—Ö–ª–µ (–ø—Ä–∏–Ω—Ü–∏–ø —è—â–∏–∫–æ–≤)** –Ω–µ–∏–∑–±–µ–∂–Ω–æ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç **–∫–æ–ª–ª–∏–∑–∏–∏**: –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –∫–ª—é—á–µ–π –ø–æ–ø–∞–¥–µ—Ç –≤ –æ–¥–Ω—É –∏ —Ç—É –∂–µ –ø–∞—Ä—Ç–∏—Ü–∏—é.

---

### –°—Ü–µ–Ω–∞—Ä–∏–π: –í –ø–∞—Ä—Ç–∏—Ü–∏–∏ ‚Ññ42 –æ–∫–∞–∑–∞–ª–∏—Å—å –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–î–æ–ø—É—Å—Ç–∏–º, –±–ª–∞–≥–æ–¥–∞—Ä—è —Ö—ç—à—É:
*   –í—Å–µ —Å–æ–±—ã—Ç–∏—è `userId = 123` –ø–æ–ø–∞–¥–∞—é—Ç –≤ **Partition #42**.
*   –í—Å–µ —Å–æ–±—ã—Ç–∏—è `userId = 789` *—Ç–æ–∂–µ* –ø–æ–ø–∞–¥–∞—é—Ç –≤ **Partition #42**.

–¢–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏–º –Ω–∞ **Consumer Group**. –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –∑–∞ Partition #42 –∑–∞–∫—Ä–µ–ø–ª–µ–Ω **–æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å** ‚Äî Consumer Instance #3.

**–ö–∞–∫ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞?**

Consumer Instance #3 —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Partition #42 **—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É** (–≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ –±—ã–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ø–∞—Ä—Ç–∏—Ü–∏—é). –û–Ω –≤–∏–¥–∏—Ç –ø–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, **–ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**:

```
[–ü–æ—Ä—è–¥–æ–∫ –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏] -> [–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º]
---
1. {key: "123", value: "Alice: +$100"}  -> 1. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Alice +$100
2. {key: "789", value: "Bob: +‚Ç¨250"}    -> 2. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Bob +‚Ç¨250
3. {key: "123", value: "Alice: -$50"}   -> 3. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Alice -$50
4. {key: "789", value: "Bob: -‚Ç¨100"}    -> 4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Bob -‚Ç¨100
5. {key: "123", value: "Alice: +$200"}  -> 5. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Alice +$200
```

### –ö–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥:

**–ü–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω *—Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞* –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏.**

*   **–î–ª—è `userId=123` –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:** `+$100` -> `-$50` -> `+$200`. Consumer –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Ö –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
*   **–î–ª—è `userId=789` –ø–æ—Ä—è–¥–æ–∫ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:** `+‚Ç¨250` -> `-‚Ç¨100`.
*   **–ù–æ –ø–æ—Ä—è–¥–æ–∫ *–º–µ–∂–¥—É* —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ –≤–∞–∂–µ–Ω:** –û–±—Ä–∞–±–æ—Ç–∫–∞ `Bob: +‚Ç¨250` —Å–ª—É—á–∏–ª–∞—Å—å *–ø–æ—Å–ª–µ* `Alice: +$100`
    –∏ *–¥–æ* `Alice: -$50`. –≠—Ç–æ –Ω–µ –∏–º–µ–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–∞–∫ —ç—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —Ä–∞–∑–Ω—ã–º–∏ —Å—á–µ—Ç–∞–º–∏.

> –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å **–Ω–µ –≤—ã–¥–µ–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫** –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–Ω –∏–º–µ–µ—Ç –æ–¥–∏–Ω –ø–æ—Ç–æ–∫, —á–∏—Ç–∞—é—â–∏–π –ø–∞—Ä—Ç–∏—Ü–∏—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. 
> –ù–æ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ (–≤ —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö `AccountService`), —ç—Ç–∞ 
> –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –Ω–∏—Ö.

### –ê–Ω–∞–ª–æ–≥–∏—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ **–ø–∞—Ä—Ç–∏—Ü–∏—è ‚Äî —ç—Ç–æ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω–∞—è –ª–µ–Ω—Ç–∞**, –∞ **–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å ‚Äî —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –Ω–∞ –∫–æ–Ω—Ü–µ —ç—Ç–æ–π –ª–µ–Ω—Ç—ã**.

–ù–∞ –ª–µ–Ω—Ç—É –ø–æ–ø–∞–¥–∞—é—Ç **–∫–æ—Ä–æ–±–∫–∏** (—Å–æ–æ–±—â–µ–Ω–∏—è) –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π). –ö–æ—Ä–æ–±–∫–∏ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–æ–º–µ—á–µ–Ω—ã –µ–≥–æ ID (–∫–ª—é—á).

*   **–†–∞–±–æ—á–∏–π –∑–∞–±–∏—Ä–∞–µ—Ç –∫–æ—Ä–æ–±–∫–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É:** —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ–±–∫—É ‚Ññ1 –¥–ª—è –ó–∞–∫–∞–∑—á–∏–∫–∞ –ê, –ø–æ—Ç–æ–º –∫–æ—Ä–æ–±–∫—É ‚Ññ2 –¥–ª—è –ó–∞–∫–∞–∑—á–∏–∫–∞ –ë, –ø–æ—Ç–æ–º –∫–æ—Ä–æ–±–∫—É ‚Ññ3 –¥–ª—è –ó–∞–∫–∞–∑—á–∏–∫–∞ –ê.
*   **–†–∞–±–æ—á–∏–π –∑–Ω–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å:** –û–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ ID –∑–∞–∫–∞–∑—á–∏–∫–∞ –∏ –æ—Ç–Ω–æ—Å–∏—Ç –∫–æ—Ä–æ–±–∫—É –ê –∫ —Å—Ç–æ–ø–∫–µ "–ó–∞–∫–∞–∑—á–∏–∫ –ê", –∞ –∫–æ—Ä–æ–±–∫—É –ë –∫ —Å—Ç–æ–ø–∫–µ "–ó–∞–∫–∞–∑—á–∏–∫ –ë".
*   **–í –∏—Ç–æ–≥–µ:** –í —Å—Ç–æ–ø–∫–µ "–ó–∞–∫–∞–∑—á–∏–∫ –ê" –∫–æ—Ä–æ–±–∫–∏ –ª–µ–∂–∞—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (‚Ññ1, –ø–æ—Ç–æ–º ‚Ññ3). –í —Å—Ç–æ–ø–∫–µ "–ó–∞–∫–∞–∑—á–∏–∫ –ë" —Ç–æ–∂–µ –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω (‚Ññ2). 
    –ù–æ –æ–±—â–∞—è –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω–æ–π –ª–µ–Ω—Ç–µ –ø–µ—Ä–µ–º–µ—à–∞–Ω–∞.

---

### –ò—Ç–æ–≥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

–ù–∞ –≤–æ–ø—Ä–æ—Å: *"–ê –µ—Å–ª–∏ –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏?"* ‚Äî –≤—ã —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –¥–∞—Ç—å –±–ª–µ—Å—Ç—è—â–∏–π –æ—Ç–≤–µ—Ç:

> –≠—Ç–æ —à—Ç–∞—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è. –û–¥–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –±—É–¥–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞—Ç—å –æ–±—â–∏–π –ø–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ø–∞—Ä—Ç–∏—Ü–∏–∏. 
> –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π *–º–µ–∂–¥—É* —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –æ–Ω –∏ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ (–ø–æ –∏—Ö –∫–ª—é—á–∞ - ID).
> –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π *–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è* –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥—É—Ç –ø–æ–¥—Ä—è–¥ 
> –≤ —ç—Ç–æ–º –æ–±—â–µ–º –ø–æ—Ç–æ–∫–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª—é—á–∞, 
> –∞ –Ω–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏.

---

–µ—Å–ª–∏ —è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ª–∏—Å–µ–Ω–µ—Ä–∞ –ø–æ—Å—Ç–∞–≤–ª—é concurrency = "1", –∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π (–∫–æ—Ä–∑–∏–Ω/–ª–µ–Ω—Ç) –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤—Å—ë —Ç–∞–∫–∂–µ 1000, —Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ —É –Ω–∞—Å 1 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å? –ò –∫–∞–∫ –æ–Ω 1 –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å –∑–∞–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–∏—Ö 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π?

–ò–¥–µ–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –ø–æ–Ω—è—Ç—å —Å–∞–º –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã. **–î–∞, –≤—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã –≤ —Å–≤–æ–∏—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö.**

–ï—Å–ª–∏ –≤—ã –ø–æ—Å—Ç–∞–≤–∏—Ç–µ `concurrency = "1"` –ø—Ä–∏ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π, —É –≤–∞—Å –±—É–¥–µ—Ç **–æ–¥–∏–Ω-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å (consumer instance) –≤ –≥—Ä—É–ø–ø–µ**, –∏ —ç—Ç–æ—Ç –±–µ–¥–Ω—è–≥–∞ –±—É–¥–µ—Ç –≤—ã–Ω—É–∂–¥–µ–Ω —á–∏—Ç–∞—Ç—å **—Å–æ –≤—Å–µ—Ö 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ –∏ —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç.

### –ö–∞–∫ –æ–¥–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —á–∏—Ç–∞–µ—Ç —Å 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π?

1.  **–ù–µ –ø—É—Ç–∞–π—Ç–µ "–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è" –∏ "–ø–æ—Ç–æ–∫".** –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Spring Kafka `concurrency = "1"` –æ–±—ã—á–Ω–æ —Å–æ–∑–¥–∞–µ—Ç **–æ–¥–∏–Ω –ø–æ—Ç–æ–∫** –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –∏ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–º —Å–∞–º—ã–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º –≤ –≥—Ä—É–ø–ø–µ.

2.  **–≠—Ç–æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–µ—Å—å —Ç–æ–ø–∏–∫.** –ö–æ–≥–¥–∞ –æ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Kafka, –±—Ä–æ–∫–µ—Ä –≤–∏–¥–∏—Ç: "–ê–≥–∞, –≤ –≥—Ä—É–ø–ø–µ `transaction-processors` –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫. –ó–Ω–∞—á–∏—Ç, –æ–Ω –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å —Å–æ *–≤—Å–µ—Ö* –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–æ–ø–∏–∫–∞ `financial-transactions`".

3.  **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –í–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ü–∏–∫–ª (`poll loop`), –∫–æ—Ç–æ—Ä—ã–π:
  *   –û–ø—Ä–∞—à–∏–≤–∞–µ—Ç (**polls**) –≤—Å–µ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π —Ä–∞–∑–æ–º.
  *   –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (batches) —Å–æ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π.
  *   –í–∞—à –º–µ—Ç–æ–¥ `processTransaction` –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —ç—Ç–∏—Ö –ø–∞—á–µ–∫, –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø–æ–ª—É—á–µ–Ω–∏—è.

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –æ–¥–∏–Ω-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–¥ 1000 –∫–æ–Ω–≤–µ–π–µ—Ä–Ω—ã—Ö –ª–µ–Ω—Ç (–ø–∞—Ä—Ç–∏—Ü–∏–π). –û–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –≤—Å–µ—Ö, –ø–æ—ç—Ç–æ–º—É –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:
1.  –ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–±–µ–≥–∞–µ—Ç –≤–¥–æ–ª—å –≤—Å–µ—Ö –ª–µ–Ω—Ç –∏ —Å–º–æ—Ç—Ä–∏—Ç, –Ω–∞ –∫–∞–∫–∏—Ö –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∫–æ—Ä–æ–±–∫–∏.
2.  –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50 –∫–æ—Ä–æ–±–æ–∫ —Å 50 —Ä–∞–∑–Ω—ã—Ö –ª–µ–Ω—Ç).
3.  –û—Ç–Ω–æ—Å–∏—Ç —ç—Ç—É –≥–æ—Ä—É –∫–æ—Ä–æ–±–æ–∫ –Ω–∞ —Å—Ç–æ–ª –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –∏—Ö –≤—Å–∫—Ä—ã–≤–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **—Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–π**.
4.  –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —à–∞–≥—É 1.

---

### –ö–∞–∫–æ–≤—ã –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ç–∞–∫–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è?

–≠—Ç–æ **–∫—Ä–∞–π–Ω–µ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è** –∏ **–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è. –û–Ω–∞ —É–±–∏–≤–∞–µ—Ç –≤—Å—é –∏–¥–µ—é Kafka.

1.  **–ù—É–ª–µ–≤–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º:** –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —É–ø—Ä–µ—Ç—Å—è –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞. –≠—Ç–æ **–≥–ª–∞–≤–Ω–æ–µ "–±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ"** (bottleneck).

2.  **–ù–∏–∑–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤ ~1000 —Ä–∞–∑ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –µ—Å–ª–∏ –±—ã –æ–Ω–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–ª–∏—Å—å –º–µ–∂–¥—É 1000 –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π.

3.  **–†–∏—Å–∫ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è (Lag):** –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ —É—Å–ø–µ–≤–∞–µ—Ç –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –±—É–¥–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è **–æ–≥—Ä–æ–º–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** (consumer lag). –í –∏—Ç–æ–≥–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É—Å—Ç–∞—Ä–µ–≤–∞—Ç—å –µ—â–µ –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

4.  **–†–∏—Å–∫ —Å–±–æ—è:** –ï—Å–ª–∏ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–¥–µ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.

### –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –±—ã –≤ –∫–æ–¥–µ (–ø—Å–µ–≤–¥–æ–∫–æ–¥ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è)

```kotlin
// –ü—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º Kafka
fun runSingleConsumer() {
    while (true) {
        // –û–¥–∏–Ω poll() –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ä–∞–∑—É —Å–æ –í–°–ï–• 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π
        val records = consumer.poll(Duration.ofMillis(100))
        
        for (record in records) { // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞!
            // –ó–¥–µ—Å—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–∞—à @KafkaListener –º–µ—Ç–æ–¥
            processTransaction(record.value(), record.key(), record.partition())
        }
        // –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ–π –ø–∞—á–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º offset'—ã –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π —Ä–∞–∑–æ–º
        consumer.commitSync() 
    }
}
```

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (–ø–æ—Ç–æ–∫–æ–≤) –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **—Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä—Ç–∏—Ü–∏–π** –≤ —Ç–æ–ø–∏–∫–µ, —á—Ç–æ–±—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 
—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã.

*   **–ò–¥–µ–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π:** `concurrency` = `number_of_partitions` (–µ—Å–ª–∏ –æ–¥–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ç–æ–ª—å–∫–æ –ø–æ—Ç—è–Ω—É—Ç—å).
*   **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ª—É—á–∞–π:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –ø–æ–¥–æ–≤ –≤ Kubernetes), –∏ –≤ –∫–∞–∂–¥–æ–º –≤—ã—Å—Ç–∞–≤–∏—Ç—å `concurrency = 10`. 
    –í —Å—É–º–º–µ –≥—Ä—É–ø–ø–∞ –±—É–¥–µ—Ç –∏–º–µ—Ç—å 10 * 10 = 100 –ø–æ—Ç–æ–∫–æ–≤-–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π 1000 –ø–∞—Ä—Ç–∏—Ü–∏–π (–∫–∞–∂–¥–æ–º—É –¥–æ—Å—Ç–∞–Ω–µ—Ç—Å—è 
    –ø–æ ~10 –ø–∞—Ä—Ç–∏—Ü–∏–π).

**–í—ã–≤–æ–¥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:** –í—ã –∑–∞–¥–∞–ª–∏ –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–ª—é—á–µ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã Kafka. 
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: **–æ–¥–∏–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ *–º–æ–∂–µ—Ç* —á–∏—Ç–∞—Ç—å —Å –ª—é–±–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π, –Ω–æ —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Å–µ—Ä—å–µ–∑–Ω–µ–π—à–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 
—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∏–≤–µ–ª–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏, —Ä–∞–¥–∏ –∫–æ—Ç–æ—Ä—ã—Ö Kafka –∏ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å.** 
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –¥–æ–ª–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä—Ç–∏—Ü–∏–π.

---


# 5) Rebalance (–ø–æ—á–µ–º—É ¬´–¥–µ—Ä–≥–∞–µ—Ç—Å—è¬ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ)

–ö–æ–≥–¥–∞ –≤ –≥—Ä—É–ø–ø—É **–≤—Ö–æ–¥–∏—Ç/–≤—ã—Ö–æ–¥–∏—Ç** consumer, –º–µ–Ω—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ partitions, Kafka –¥–µ–ª–∞–µ—Ç **rebalance** ‚Äî –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç partitions.
–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: `Range` / `RoundRobin` / `Sticky` / `CooperativeSticky` (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–ø-—Å–≤–µ—Ç).

- **–ü—Ä–∞–∫—Ç–∏–∫–∞**: –¥–µ—Ä–∂–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –±—ã—Å—Ç—Ä–æ–π (–∏–ª–∏ –≤—ã–Ω–æ—Å–∏ —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É –≤ worker-–ø—É–ª—ã), –∏–Ω–∞—á–µ —Ä–∏—Å–∫—É–µ—à—å —Å–ª–æ–≤–∏—Ç—å `max.poll.interval.ms` –∏ 
  –≤—ã–ª–µ—Ç –∏–∑ –≥—Ä—É–ø–ø—ã ‚Üí –ª–∏—à–Ω–∏–π —Ä–µ–±–∞–ª–∞–Ω—Å.

# 6) –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —á–∏—Å–ª–æ partitions

–ü—Ä–∞–≤–∏–ª–æ: –ø–ª–∞–Ω–∏—Ä—É–π –ø–æ–¥ **–Ω—É–∂–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º —Å–µ–π—á–∞—Å + –∑–∞–ø–∞—Å**.

**–ü—Ä–∏–º–µ—Ä:** 
—Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å ~2 000 msg/s –ø—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ ~200 msg/s –Ω–∞ –ø–æ—Ç–æ–∫.
–ù—É–∂–Ω–æ ~10 –ø–æ—Ç–æ–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚Üí —Å–¥–µ–ª–∞–π **–º–∏–Ω–∏–º—É–º 10 partitions** (–ª—É—á—à–µ 12‚Äì16 –ø–æ–¥ –∑–∞–ø–∞—Å –∏ –±—É–¥—É—â–∏–π —Ä–æ—Å—Ç).
**–í–∞–∂–Ω–æ:** **—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å partitions –º–æ–∂–Ω–æ**, –Ω–æ **—É–º–µ–Ω—å—à–∞—Ç—å** ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–ª—å–∑—è –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞.

# 7) Spring Kafka / Java: —á—Ç–æ –∑–Ω–∞—á–∏—Ç `concurrency`

–í Spring Kafka `@KafkaListener(concurrency = "N")` —Å–æ–∑–¥–∞—ë—Ç **N consumer-–ø–æ—Ç–æ–∫–æ–≤** (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞). 
–ù–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω **—á–∏—Å–ª–æ–º partitions**.

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–∞—Ä–∫–∞—Å:

```java
@EnableKafka
@Configuration
class KafkaConfig {

  @Bean
  ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory(
      ConsumerFactory<String, String> cf) {
    var f = new ConcurrentKafkaListenerContainerFactory<String, String>();
    f.setConsumerFactory(cf);
    // –ü–∞—Ä–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:
    // f.getContainerProperties().setAckMode(ContainerProperties.AckMode.RECORD);   // commit –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
    // f.setCommonErrorHandler(new DefaultErrorHandler(recoverer, new FixedBackOff(1000L, 3L)));
    return f;
  }
}

@Service
class MyListener {

  // –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –ø–æ—Ç–æ–∫–æ–≤ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞
  @KafkaListener(topics = "orders", groupId = "billing", concurrency = "6")
  public void onMessage(ConsumerRecord<String, String> rec) {
    // –í–ê–ñ–ù–û: –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ ‚Üí –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º.
    // –ü–æ—Ä—è–¥–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ key —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–Ω–æ–π partition.
    // –ê –∫–∞–∫ –º—ã –∑–Ω–∞–µ–º, –µ—Å–ª–∏ –∑–∞–¥–∞–≤–∞—Ç—å key, —Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–¥–Ω–∏–º key –ø–æ–ø–∞–¥—É—Ç –≤ –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—Ü–∏—é.
  }
}
```

**–í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å:**

* `concurrency` > `partitions` ‚Üí —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–æ–≤ –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—Ç—å.
* –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ** partitions, –Ω–æ **—Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏.
* –î–ª–∏–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞? –õ–∏–±–æ –ø–æ–¥–Ω–∏–º–∏ `max.poll.interval.ms`, –ª–∏–±–æ **–¥–µ–ª–µ–≥–∏—Ä—É–π** —Ä–∞–±–æ—Ç—É –≤ executor –∏ –∏—Å–ø–æ–ª—å–∑—É–π `pause()/resume()` partitions, 
  –ª–∏–±–æ –≤–∫–ª—é—á–∞–π –±–∞—Ç—á–∏ (`BatchListener` + `max.poll.records`) ‚Äî –∏ **–∫–æ–º–º–∏—Ç—å** –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.
* –î–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –ø–æ `key` ‚Äî **–Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition**.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∂—ë—Å—Ç–∫–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã –∑–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–º (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å), –º–æ–∂–Ω–æ —Ç–∞–∫:

```java
@KafkaListener(groupId = "analytics",
  topicPartitions = {
    @TopicPartition(topic = "events", partitions = {"0","1","2"})
})
public void on(ConsumerRecord<String, String> rec) { ... }
```

# 8) –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö (–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã)

**Q: –ß—Ç–æ –¥–∞—ë—Ç partition?**
- A: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–∑–æ–ª—è—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞: –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition. (–ø—Ä–∏–º–µ—Ä, —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏)

**Q: –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞?**
- A: `min(#partitions, #consumers –≤ –≥—Ä—É–ø–ø–µ)`.

**Q: –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?**
- A: –ö–ª—é—á—É–π —Å–æ–æ–±—â–µ–Ω–∏—è `key = userId`, —á—Ç–æ–±—ã –≤—Å–µ –æ–Ω–∏ –ø–æ–ø–∞–ª–∏ –≤ –æ–¥–Ω—É partition (—Ä–∞–∑–¥–µ–ª).

**Q: –ü–æ—á–µ–º—É –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ consumers –Ω–∏—á–µ–≥–æ –Ω–µ —É—Å–∫–æ—Ä–∏–ª–æ—Å—å?**
- A: –ü–æ—Ç–æ–º—É —á—Ç–æ —É–ø—ë—Ä–ª–∏—Å—å –≤ —á–∏—Å–ª–æ partitions; –ª–∏—à–Ω–∏–µ consumers –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç.

**Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è offsets?**
- A: –í —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Ç–æ–ø–∏–∫–µ `__consumer_offsets`, –ø–æ (group, partition).

**Q: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π –ø—Ä–∏ `at-least-once`?**
- A: –°–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, upsert –ø–æ –∫–ª—é—á—É, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ eventId).

**Q: –ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ–±–∞–ª–∞–Ω—Å –∏ –∫–∞–∫ –µ–≥–æ —Å–º—è–≥—á–∏—Ç—å?**
- A: –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –≥—Ä—É–ø–ø–µ; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sticky/cooperative assignor, –∏–∑–±–µ–≥–∞—Ç—å –¥–æ–ª–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫/stop-the-world.

**Q: –ö–∞–∫ –ø–æ–¥–æ–±—Ä–∞—Ç—å #partitions?**
- A: –û—Ç —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞/–ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ–π—á–∞—Å + –∑–∞–ø–∞—Å (—É—á—Ç–∏, —É–º–µ–Ω—å—à–∞—Ç—å –Ω–µ–ª—å–∑—è).

---


# üìù Kafka + Spring Kafka —à–ø–∞—Ä–≥–∞–ª–∫–∞

---

## 1. –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã

* **Topic** ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ—Ä–æ–≥–∞).
* **Partition** ‚Äî ¬´–ø–æ–ª–æ—Å–∞¬ª –≤–Ω—É—Ç—Ä–∏ —Ç–æ–ø–∏–∫–∞, —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ offset.
* **Consumer group** ‚Äî –≥—Ä—É–ø–ø–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —á–∏—Ç–∞—é—Ç —Ç–æ–ø–∏–∫ (–∫–∞–∂–¥—ã–π partition ‚Üí —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É consumer –≤ –≥—Ä—É–ø–ø–µ).
* **Offset** ‚Äî –ø–æ–∑–∏—Ü–∏—è –≤ partition.

---

## 2. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (concurrency)

* –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω:

```
  concurrency = min(#partitions, #consumers –≤ group)
```

* –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition —Å–æ–æ–±—â–µ–Ω–∏—è **—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É**.
* –ü–æ—Ä—è–¥–æ–∫ –º–µ–∂–¥—É partition **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è**.

üëâ –ß—Ç–æ–±—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –ø–æ –ø–æ—Ä—è–¥–∫—É ‚Üí `key = userId`.

---

## 3. Producer (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```yaml
spring:
  kafka:
    producer:
      bootstrap-servers: localhost:9092
      acks: all        # –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –≤—Å–µ—Ö —Ä–µ–ø–ª–∏–∫
      retries: 3       # —Ä–µ—Ç—Ä–∞–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      properties:
        enable.idempotence: true   # –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–Ω–µ—Ç –¥—É–±–ª–µ–π)
        max.in.flight.requests.per.connection: 1
```

–ö–æ–¥:

```java
@Service
class Producer {
  private final KafkaTemplate<String, String> template;

  public Producer(KafkaTemplate<String, String> template) {
    this.template = template;
  }

  public void send(String key, String value) {
    template.send("orders", key, value);
  }
}
```

---

## 4. Consumer (—á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)

–ù–∞—Å—Ç—Ä–æ–π–∫–∏:

```yaml
spring:
  kafka:
    consumer:
      bootstrap-servers: localhost:9092
      group-id: billing-service
      enable-auto-commit: false
      auto-offset-reset: earliest
      max-poll-records: 50  # –∑–∞ —Ä–∞–∑ —á–∏—Ç–∞–µ–º –¥–æ 50 —Å–æ–æ–±—â–µ–Ω–∏–π
```

–ö–æ–¥:

```java
@Service
class MyListener {

  // concurrency = –∫–æ–ª-–≤–æ consumer-–ø–æ—Ç–æ–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  @KafkaListener(topics = "orders", concurrency = "4")
  public void onMessage(ConsumerRecord<String, String> rec) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    System.out.println("Got: " + rec.value());
  }
}
```

---

## 5. Commit offsets

* **At-most-once**: `commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏` (–±—ã—Å—Ç—Ä–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è).
* **At-least-once (–¥–µ—Ñ–æ–ª—Ç)**: `–æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí commit` (–Ω–∞–¥—ë–∂–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏).
* **Exactly-once**: `—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏` (–¥–æ—Ä–æ–∂–µ, —Ä–µ–¥–∫–æ –Ω–∞–¥–æ).

–ü—Ä–∏–º–µ—Ä —Ä—É—á–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞:

```java
@KafkaListener(topics = "orders")
public void listen(ConsumerRecord<String, String> rec, Acknowledgment ack) {
    try {
        process(rec.value());
        ack.acknowledge(); // –∫–æ–º–º–∏—Ç offset
    } catch (Exception e) {
        // –Ω–µ –∫–æ–º–º–∏—Ç–∏–º, —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è
    }
}
```

---

## 6. –û—à–∏–±–∫–∏ –∏ —Ä–µ—Ç—Ä–∞–∏

* **DefaultErrorHandler** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ + —Ä–µ—Ç—Ä–∞–∏.
* **DLT (Dead Letter Topic)** ‚Äî —Ç–æ–ø–∏–∫ –¥–ª—è ¬´–ø–ª–æ—Ö–∏—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π.

–ü—Ä–∏–º–µ—Ä:

```java
@Bean
public DefaultErrorHandler errorHandler(KafkaTemplate<Object, Object> template) {
    var recoverer = new DeadLetterPublishingRecoverer(template);
    var backOff = new FixedBackOff(1000L, 3L);          // 3 —Ä–µ—Ç—Ä–∞—è —Å –ø–∞—É–∑–æ–π 1—Å
    return new DefaultErrorHandler(recoverer, backOff);
}
```

---

## 7. –ü–∞—É–∑–∞ / —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ (pause / resume)

–ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—è–∂—ë–ª–∞—è:

```java
@KafkaListener(id = "orders", topics = "orders")
public void listen(ConsumerRecord<String, String> rec, 
                   Acknowledgment ack, 
                   Consumer<?,?> consumer) {
    consumer.pause(Collections.singleton(new TopicPartition("orders", rec.partition())));
    try {
        process(rec.value());
        ack.acknowledge();
    } finally {
        consumer.resume(Collections.singleton(new TopicPartition("orders", rec.partition())));
    }
}
```

---

## 8. –ü–æ–ª–µ–∑–Ω—ã–µ –ø—Ä–æ–ø—Å—ã

* `max.poll.records` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑ —Ç—è–Ω–µ–º.
* `max.poll.interval.ms` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É `poll()` (—É–≤–µ–ª–∏—á–∏–≤–∞–π –ø—Ä–∏ –¥–æ–ª–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ).
* `session.timeout.ms` ‚Äî –≤—Ä–µ–º—è, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–µ consumer —Å—á–∏—Ç–∞–µ—Ç—Å—è –º—ë—Ä—Ç–≤—ã–º.
* `fetch.min.bytes` / `fetch.max.wait.ms` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º/–∑–∞–¥–µ—Ä–∂–∫–æ–π –ø–∞–∫–µ—Ç–æ–≤.

---

## 9. –ß–∞—Å—Ç—ã–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

* **Q: –ß—Ç–æ –¥–∞—ë—Ç partition?**
  –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ (–≤–Ω—É—Ç—Ä–∏ partition).
* **Q: –ü–æ—á–µ–º—É –ª–∏—à–Ω–∏–µ consumers –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç?**
  –ü–æ—Ç–æ–º—É —á—Ç–æ consumers > partitions.
* **Q: –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?**
  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å key ‚Üí –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —ç—Ç–æ–≥–æ key –≤ –æ–¥–Ω–æ–π partition.
* **Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è offsets?**
  –í —Ç–æ–ø–∏–∫–µ `__consumer_offsets` (–ø–æ –≥—Ä—É–ø–ø–µ –∏ partition).
* **Q: –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π?**
  –°–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ eventId).
* **Q: –ß—Ç–æ —Ç–∞–∫–æ–µ rebalance?**
  –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –º–µ–∂–¥—É consumers (–ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤).

---

üìå **–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ**:

* –ë–æ–ª—å—à–µ partitions ‚Üí –≤—ã—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ –ø–æ—Ä—è–¥–æ–∫.
* –ü–æ—Ä—è–¥–æ–∫ –ø–æ `key` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π `partition`.
* –î—É–±–ª–∏ ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –¥–µ–ª–∞–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º.

---

–û—Ç–ª–∏—á–Ω—ã–π, –æ—á–µ–Ω—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å - –ü—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–µ–π ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö —Ç–µ–º –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö. 
–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –Ω—É–ª—è, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –Ω–∞ Kotlin.

### 1. –ß—Ç–æ —Ç–∞–∫–æ–µ "–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å" (Idempotence)?

**–ü—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** –û–ø–µ—Ä–∞—Ü–∏—è –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π, –µ—Å–ª–∏ **–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–∞—ë—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ –∏ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ**.

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**
*   **–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è:** `–æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS("–ü—Ä–∏–≤–µ—Ç")`. –ï—Å–ª–∏ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É 5 —Ä–∞–∑, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç 5 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö SMS. –≠—Ç–æ –¥—É–±–ª–∏.
*   **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è:** `—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ = "–í–´–ü–û–õ–ù–ï–ù"`. –°–∫–æ–ª—å–∫–æ –±—ã —Ä–∞–∑ –≤—ã –Ω–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É, —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è `"–í–´–ü–û–õ–ù–ï–ù"`. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—Ç –∂–µ.

---

### 2. –ü–æ—á–µ–º—É –≤ Kafka –≤–æ–∑–Ω–∏–∫–∞—é—Ç –¥—É–±–ª–∏?

Consumer –≤ Kafka —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Å—Ö–µ–º–µ **"–ø—Ä–æ—á–∏—Ç–∞–ª -> –æ–±—Ä–∞–±–æ—Ç–∞–ª -> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª (committed offset)"**. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ –º–µ–∂–¥—É "–æ–±—Ä–∞–±–æ—Ç–∞–ª" –∏ "–ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª" –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Å–±–æ–π.

1.  Consumer —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `offset=100` (Event: `userId=123, eventId="abc", amount=+100`).
2.  –û–Ω —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ: –Ω–∞—á–∏—Å–ª—è–µ—Ç 100 —Ä—É–±. –Ω–∞ —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
3.  **–ü–ï–†–ï–î –¢–ï–ú** –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–∫–µ—Ä—É (commit offset=100), consumer –ø–∞–¥–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ OOM –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–∞ –≤ Kubernetes).
4.  Consumer –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. Kafka –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π offset —ç—Ç–æ `99`.
5.  Consumer —Å–Ω–æ–≤–∞ —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `offset=100` –∏ **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ**. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥—É–±–ª—å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –µ—â–µ +100 —Ä—É–±.

---

### 3. –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π? (–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)

–í–æ—Ç –≥–ª–∞–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã, –æ—Ç —Å–∞–º—ã—Ö –ø—Ä–æ—Å—Ç—ã—Ö –∫ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º.

#### –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ "–ë—ã–ª–æ –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–∞–Ω—å—à–µ?"

–≠—Ç–æ —Å–∞–º—ã–π –ø—Ä—è–º–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≥–¥–µ-—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–∫—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ `eventId`.

**–®–∞–≥ 1:** –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–±—ã—Ç–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (`eventId` –∏–ª–∏ `idempotencyKey`).

```kotlin
// Event-Driven –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞
data class DepositMoneyEvent(
    val eventId: UUID, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
    val userId: String,
    val amount: BigDecimal,
    val timestamp: Instant
)
```

**–®–∞–≥ 2:** –ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î, –≤–∏–¥–µ–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç `eventId`.

```kotlin
// Consumer.kt
@KafkaListener(topics = ["deposit-events"])
fun processDepositEvent(event: DepositMoneyEvent) {

    // –ò–î–ï–ú–ü–û–¢–ï–ù–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
    // –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å eventId –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É "–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π"
    val isDuplicate = processedEventRepository.tryInsertEventId(event.eventId)

    if (isDuplicate) {
        logger.warn { "Duplicate event ${event.eventId} detected. Skipping." }
        return // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
    }

    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥—É–±–ª—å, –≤—ã–ø–æ–ª–Ω—è–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
    logger.info { "Processing unique event ${event.eventId}" }
    walletService.depositMoney(event.userId, event.amount)
}
```

**–®–∞–≥ 3:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ó–¥–µ—Å—å –≤–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—É—Å–ª–æ–≤–∏–µ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å** –≤ –ë–î.

```kotlin
// ProcessedEventRepository.kt
import org.springframework.jdbc.core.JdbcTemplate
import java.util.UUID

class ProcessedEventRepository(private val jdbcTemplate: JdbcTemplate) {

    fun tryInsertEventId(eventId: UUID): Boolean {
        return try {
            // –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å ID. –ï—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å - –±—É–¥–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑-–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ constraint.
            jdbcTemplate.update(
                "INSERT INTO processed_events (event_id) VALUES (?) ON CONFLICT (event_id) DO NOTHING",
                eventId.toString()
            )
            // –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ 0 —Å—Ç—Ä–æ–∫ -> —ç—Ç–æ –¥—É–±–ª—å
            // –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ 1 —Å—Ç—Ä–æ–∫–∞ -> —ç—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
            false // –ù–µ –¥—É–±–ª—å
        } catch (e: DataAccessException) {
            // –õ–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –¥—Ä—É–≥–∏—Ö –ë–î)
            true // –î—É–±–ª—å
        }
    }
}
```

- **–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** <br> 
  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—Å—Ç–∞–≤–∫–∞ `eventId` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–∞—Ç–æ–º–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π** (–≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏). 
  –≠—Ç–æ –∑–∞—â–∏—Ç–∏—Ç –æ—Ç `race condition`, –µ—Å–ª–∏ –¥–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–¥—É—Ç –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö.

---

#### –°–ø–æ—Å–æ–± 2: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ ("–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ wins")

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ —Å–≤–æ–µ–π –ø—Ä–∏—Ä–æ–¥–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã, –∏–ª–∏ –≥–¥–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ü—Ä–∏–º–µ—Ä: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏.**

```kotlin
data class UpdateAddressEvent(
    val eventId: UUID,
    val userId: String,
    val newAddress: String,
    val updateTimestamp: Instant // –í–∞–∂–Ω–æ! –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
)

// Consumer
fun processAddressEvent(event: UpdateAddressEvent) {

    val currentUser = userRepository.findById(event.userId)

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–º
    if (currentUser.lastAddressUpdateTimestamp.isAfter(event.updateTimestamp)) {
        logger.info { "Event ${event.eventId} is outdated. Skipping." }
        return
    }

    // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å–≤–µ–∂–µ–µ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –∏ –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
    userRepository.updateAddress(event.userId, event.newAddress, event.updateTimestamp)
}
```
–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏–¥–µ—Ç 10 —Ä–∞–∑, –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ.

---

#### –°–ø–æ—Å–æ–± 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π Kafka

*   **Idempotent Producer:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ —Ç–æ–ø–∏–∫ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ (–∏–∑-–∑–∞ retry-–ª–æ–≥–∏–∫–∏). **–ù–æ —ç—Ç–æ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–µ–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è!**
*   **Transactional Producer:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–ø–∏–∫–æ–≤. –¢–æ–∂–µ –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è.

**–í–∞–∂–Ω–æ:** –≠—Ç–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã Kafka —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—É *–¥–æ—Å—Ç–∞–≤–∫–∏* —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º—É *–æ–±—Ä–∞–±–æ—Ç–∫–∏* –¥—É–±–ª–µ–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º. **–ü–∞—Ç—Ç–µ—Ä–Ω —Å `eventId` ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ consumer'a.**

### –ò—Ç–æ–≥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

–ù–∞ –≤–æ–ø—Ä–æ—Å "–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π?" –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–∞–∫:

**"–û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± ‚Äî —Å–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è. –î–ª—è —ç—Ç–æ–≥–æ –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (eventId). –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—á–∞—â–µ –≤—Å–µ–≥–æ –≤ –ë–î), –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —Å–æ–±—ã—Ç–∏–µ —Å —Ç–∞–∫–∏–º eventId. –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ INSERT —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å constraint. –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –º—ã –ø—Ä–æ—Å—Ç–æ –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –¥–∞–∂–µ –ø—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."**

–≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–æ—Ä–∏—é, –∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –ø–æ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã.

---

–ö–æ–Ω–µ—á–Ω–æ! –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –Ω–∞ Kotlin –∏ Spring Boot.

### –ü–æ—á–µ–º—É —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏:

1.  **–ü–æ—Ç–æ–∫ 1** –ø—Ä–∏–Ω–æ—Å–∏—Ç —Å–æ–±—ã—Ç–∏–µ —Å `eventId = "abc"`.
2.  –û–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î: `SELECT * FROM processed_events WHERE event_id = 'abc'`. –†–µ–∑—É–ª—å—Ç–∞—Ç: `null` (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ).
3.  **–í —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è –ü–æ—Ç–æ–∫ 2** –ø—Ä–∏–Ω–æ—Å–∏—Ç **—Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ** —Å–æ–±—ã—Ç–∏–µ —Å `eventId = "abc"`.
4.  **–ü–æ—Ç–æ–∫ 2** —Ç–æ–∂–µ –¥–µ–ª–∞–µ—Ç `SELECT ... WHERE event_id = 'abc'` –∏ —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç `null`.
5.  –û–±–∞ –ø–æ—Ç–æ–∫–∞ –≤–∏–¥—è—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –Ω–µ—Ç, –∏ –æ–±–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (`walletService.depositMoney(...)`).
6.  –û–±–∞ –ø–æ—Ç–æ–∫–∞ –¥–µ–ª–∞—é—Ç `INSERT INTO processed_events (event_id) VALUES ('abc')`.
7.  **–ò—Ç–æ–≥:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ **–¥–≤–∞–∂–¥—ã**, –∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `processed_events` —Ç–∞–∫ –∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint, –≤—Ç–æ—Ä–æ–π `INSERT` —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π, –Ω–æ –±—É–¥–µ—Ç —É–∂–µ –ø–æ–∑–¥–Ω–æ).

**–í—ã–≤–æ–¥:** –û–ø–µ—Ä–∞—Ü–∏–∏ `–ü–†–û–í–ï–†–ö–ê -> –í–°–¢–ê–í–ö–ê` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–¥–µ–ª–∏–º—ã, —Ç–æ –µ—Å—Ç—å **–∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏**.

---

### –°–ø–æ—Å–æ–± 1: `INSERT ... ON CONFLICT DO NOTHING` (–î–ª—è PostgreSQL)

–≠—Ç–æ —Å–∞–º—ã–π —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –≤—Å—Ç–∞–≤–∫—É –≤ **–æ–¥–Ω–æ–º SQL-–∑–∞–ø—Ä–æ—Å–µ**.

```kotlin
import org.springframework.jdbc.core.JdbcTemplate
import org.springframework.stereotype.Repository
import java.util.UUID

@Repository
class ProcessedEventRepository(private val jdbcTemplate: JdbcTemplate) {

    fun isEventProcessed(eventId: UUID): Boolean {
        // –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ. –ï—Å–ª–∏ –æ–Ω–æ –£–ñ–ï –µ—Å—Ç—å (–∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏),
        // —Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º (DO NOTHING) –∏ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É.
        val rowsAffected = jdbcTemplate.update(
            """
            INSERT INTO processed_events (event_id, processed_at) 
            VALUES (?, NOW()) 
            ON CONFLICT (event_id) DO NOTHING
            """,
            eventId.toString()
        )

        // –ï—Å–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ 0 —Å—Ç—Ä–æ–∫ -> –≤—Å—Ç–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ -> —Å–æ–±—ã—Ç–∏–µ –£–ñ–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å (–¥—É–±–ª—å).
        // –ï—Å–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞ 1 —Å—Ç—Ä–æ–∫–∞ -> —Å–æ–±—ã—Ç–∏–µ –Ω–æ–≤–æ–µ.
        return rowsAffected == 0
    }
}
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ Consumer:**

```kotlin
@KafkaListener(topics = ["deposit-events"])
fun processDepositEvent(event: DepositMoneyEvent) {

    // –ê–¢–û–ú–ê–†–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Ç–æ–¥–µ!
    if (processedEventRepository.isEventProcessed(event.eventId)) {
        logger.warn { "Duplicate event ${event.eventId} detected. Skipping." }
        return // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
    }

    // –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç, —Å–æ–±—ã—Ç–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–æ–≤–æ–µ –∏ –µ–≥–æ eventId —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –ë–î.
    // –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.
    walletService.depositMoney(event.userId, event.amount)
    // –ù–µ –Ω—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å eventId –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ - –æ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!
}
```

**–ü–ª—é—Å—ã:**
*   –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å).
*   –ù–µ —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
*   –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç –ø—Ä–∏—Ä–æ–¥—ã.

---

### –°–ø–æ—Å–æ–± 2: –Ø–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å `SELECT ... FOR UPDATE`

–≠—Ç–æ –±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π SQL-–ë–î, –Ω–æ –æ–Ω —Å–ª–æ–∂–Ω–µ–µ –∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.

```kotlin
import org.springframework.stereotype.Service
import org.springframework.transaction.annotation.Transactional

@Service
class IdempotentProcessor(
    private val processedEventRepository: ProcessedEventRepository,
    private val walletService: WalletService
) {

    // –í–µ—Å—å –º–µ—Ç–æ–¥ –æ–±–µ—Ä–Ω—É—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    @Transactional
    fun processEventIfUnique(event: DepositMoneyEvent) {
        // 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ–µ –Ω–∞ –∑–∞–ø–∏—Å—å (FOR UPDATE)
        val existingEvent = processedEventRepository.findByIdWithLock(event.eventId)

        // 2. –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —ç—Ç–æ –¥—É–±–ª—å, –≤—ã—Ö–æ–¥–∏–º.
        if (existingEvent != null) {
            return
        }

        // 3. –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –µ–µ. –î—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∂–¥–∞—Ç—å
        // –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–æ–π, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—Ç –∂–µ eventId.
        processedEventRepository.save(ProcessedEventEntity(eventId = event.eventId))

        // 4. –í—ã–ø–æ–ª–Ω—è–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –í–ù–£–¢–†–ò —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏!
        walletService.depositMoney(event.userId, event.amount)
    }
}

// –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
interface ProcessedEventRepositoryJpa : JpaRepository<ProcessedEventEntity, UUID> {
    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
    @Query("SELECT e FROM ProcessedEventEntity e WHERE e.eventId = :eventId")
    @Lock(LockModeType.PESSIMISTIC_WRITE) // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ FOR UPDATE
    fun findByIdWithLock(@Param("eventId") eventId: UUID): ProcessedEventEntity?
}
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

```kotlin
@KafkaListener(topics = ["deposit-events"])
fun processDepositEvent(event: DepositMoneyEvent) {
    // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
    idempotentProcessor.processEventIfUnique(event)
}
```

**–ü–ª—é—Å—ã:**
*   –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å.
*   –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–ú–∏–Ω—É—Å—ã:**
*   –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
*   –†–∏—Å–∫ –≤–∑–∞–∏–º–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (deadlock) –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

---

### –°–ø–æ—Å–æ–± 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–∞–º–æ–π –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–∏

–ò–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã `processed_events`, –µ—Å–ª–∏ –≤–∞—à–∞ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç.

**–ü—Ä–∏–º–µ—Ä: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–∞ (Domain-Driven Design)**

```kotlin
// –ê–≥—Ä–µ–≥–∞—Ç "–ö–æ—à–µ–ª–µ–∫" —Å –≤–µ—Ä—Å–∏–µ–π
@Entity
class Wallet(
    @Id val userId: String,
    var balance: BigDecimal,
    // –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –∞–≥—Ä–µ–≥–∞—Ç–∞. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1 —Å –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º —Å–æ–±—ã—Ç–∏–µ–º.
    var version: Long
)

// –°–æ–±—ã—Ç–∏–µ —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä—Å–∏—é, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–æ –æ–∂–∏–¥–∞–µ—Ç
data class DepositMoneyEvent(
    val eventId: UUID,
    val userId: String,
    val amount: BigDecimal,
    val expectedVersion: Long // –û–∂–∏–¥–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è –∞–≥—Ä–µ–≥–∞—Ç–∞
)

// Consumer
@Transactional // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –≤–µ—Å—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
@KafkaListener(topics = ["deposit-events"])
fun processDepositEvent(event: DepositMoneyEvent) {

    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥—Ä–µ–≥–∞—Ç –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
    val wallet = walletRepository.findByUserIdForUpdate(event.userId)

    // 2. –ê–¢–û–ú–ê–†–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –Ω–∞ –¥—É–±–ª—å –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π:
    // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –≤ –ë–î –Ω–µ —Ä–∞–≤–Ω–∞ —Ç–æ–π, –∫–æ—Ç–æ—Ä—É—é –æ–∂–∏–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ,
    // –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –ª–∏–±–æ –¥—É–±–ª—å, –ª–∏–±–æ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏—à–ª–∏ –Ω–µ –ø–æ –ø–æ—Ä—è–¥–∫—É.
    if (wallet.version != event.expectedVersion) {
        return // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
    }

    // 3. –ï—Å–ª–∏ –≤—Å–µ –æ–∫, –≤—ã–ø–æ–ª–Ω—è–µ–º –ª–æ–≥–∏–∫—É –∏ –ò–ù–ö–†–ï–ú–ï–ù–¢–ò–ú –≤–µ—Ä—Å–∏—é
    wallet.balance += event.amount
    wallet.version++ // version —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è = event.expectedVersion + 1

    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—ã (userId, version) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.
    walletRepository.save(wallet)
}
```

**–ü–ª—é—Å—ã:**
*   –ù–µ –Ω—É–∂–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –¥–∞–Ω–Ω—ã–µ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è.
*   –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –¥—É–±–ª–µ–π –∏ –ø—Ä–æ–±–ª–µ–º—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ (concurrency control).

**–ú–∏–Ω—É—Å—ã:**
*   –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞.
*   –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ DDD –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ò—Ç–æ–≥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

**"–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—Å—Ç–∞–≤–∫–∞ `eventId` –±—ã–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏, —è –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å —Å `INSERT ... ON CONFLICT DO NOTHING` –¥–ª—è PostgreSQL –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –¥—Ä—É–≥–∏—Ö –ë–î. –≠—Ç–æ —Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±. –û–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–∂–µ –≤ —É—Å–ª–æ–≤–∏—è—Ö –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ —Å–º–æ–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π `eventId`, –∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç —Å–∏–≥–Ω–∞–ª –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É race condition –º–µ–∂–¥—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–º–∏ consumer'–∞–º–∏."**

–¢–∞–∫–æ–π –æ—Ç–≤–µ—Ç –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º—É, –Ω–æ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –µ—ë —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

---

–ù–æ –µ—â–µ –≤–æ–ø—Ä–æ—Å: –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á—Ç–æ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î `INSERT INTO processed_events (event_id, processed_at) VALUES (?, NOW()) ON CONFLICT (event_id) DO NOTHING` —è–≤–ª—è–µ—Ç—Å—è 
–±–ª–æ–∫–∏—Ä—É–µ–º—ã–º –∏ –µ—Å–ª–∏ –µ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–∏–Ω –ø–æ—Ç–æ–∫, —Ç–æ –¥—Ä—É–≥–æ–π –ø–æ–¥–æ–∂–¥–µ—Ç –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?


–û—Ç–ª–∏—á–Ω—ã–π, –æ—á–µ–Ω—å –≥–ª—É–±–æ–∫–∏–π –≤–æ–ø—Ä–æ—Å! –í—ã –∑–∞—Ç—Ä–æ–Ω—É–ª–∏ –≤–∞–∂–Ω–µ–π—à–∏–π –∞—Å–ø–µ–∫—Ç —Ä–∞–±–æ—Ç—ã –°–£–ë–î.

**–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:** –î–∞, –≤—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã. –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å **—è–≤–ª—è–µ—Ç—Å—è –±–ª–æ–∫–∏—Ä—É—é—â–∏–º –Ω–∞ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è**, –Ω–æ –º–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ **—É–º–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π**.

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –¥–µ—Ç–∞–ª–∏.

### –ö–∞–∫ –∏–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞?

1.  **–ü–æ—Ç–æ–∫ 1** –≤—ã–ø–æ–ª–Ω—è–µ—Ç `INSERT ... ON CONFLICT DO NOTHING` –¥–ª—è `eventId = "abc"`.
2.  –°–£–ë–î (PostgreSQL) –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º `eventId` –≤ —Ç–∞–±–ª–∏—Ü–µ. –ß—Ç–æ–±—ã —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –≤ —É—Å–ª–æ–≤–∏—è—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –æ–Ω–∞ –Ω–µ–Ω–∞–¥–æ–ª–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç **–±–ª–æ–∫–∏—Ä–æ–≤–∫—É** –Ω–∞ –∏–Ω–¥–µ–∫—Å–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è `"abc"`.
3.  **–ü–æ—Ç–æ–∫ 2**, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å `"abc"`, –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∏–Ω–¥–µ–∫—Å—É –∏ –≤–∏–¥–∏—Ç, —á—Ç–æ –∑–∞–ø–∏—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –û–Ω **–≤—Å—Ç–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å** –∏ –∂–¥–µ—Ç, –ø–æ–∫–∞ –ü–æ—Ç–æ–∫ 1 –Ω–µ —Å–Ω–∏–º–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
4.  **–ü–æ—Ç–æ–∫ 1** –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É:
    *   –ï—Å–ª–∏ `"abc"` –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ -> –æ–Ω –µ–≥–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç -> —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ—è–≤–Ω–∞—è) -> —Å–Ω–∏–º–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
    *   –ï—Å–ª–∏ `"abc"` –£–ñ–ï –±—ã–ª –≤ —Ç–∞–±–ª–∏—Ü–µ -> –æ–Ω –≤–∏–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç -> –¥–µ–ª–∞–µ—Ç `NOTHING` -> —Å–Ω–∏–º–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
5.  **–ü–æ—Ç–æ–∫ 2** –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø. –¢–µ–ø–µ—Ä—å –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é –ø—Ä–æ–≤–µ—Ä–∫—É:
    *   –ï—Å–ª–∏ –ü–æ—Ç–æ–∫ 1 –≤—Å—Ç–∞–≤–∏–ª –∑–∞–ø–∏—Å—å -> –ü–æ—Ç–æ–∫ 2 –≤–∏–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç -> `DO NOTHING` -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0 affected rows`.
    *   –ï—Å–ª–∏ –ü–æ—Ç–æ–∫ 1 —Ç–æ–∂–µ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—Å—Ç–∞–≤–∏–ª (–∑–∞–ø–∏—Å—å —É–∂–µ –±—ã–ª–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞) -> –ü–æ—Ç–æ–∫ 2 —Ç–∞–∫–∂–µ –≤–∏–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç -> `DO NOTHING` -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0 affected rows`.

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:

1.  **–û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è:** –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏—à—å –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—Å—Ç–∞–≤–∫–∏ (–º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã). –≠—Ç–æ –Ω–µ —Ç–∞ –¥–æ–ª–≥–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∫–æ—Ç–æ—Ä—É—é –¥–µ–ª–∞—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
2.  **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∏–Ω–¥–µ–∫—Å–∞, –∞ –Ω–µ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã:** –°–£–ë–î –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É `processed_events`, –∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–æ–∫—É (–∏–ª–∏, —Ç–æ—á–Ω–µ–µ, –∑–∞–ø–∏—Å—å –≤ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º –∏–Ω–¥–µ–∫—Å–µ) –¥–ª—è `eventId = "abc"`. –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è `eventId = "def"` –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
3.  **–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å:** –¢–∞–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Äî —ç—Ç–æ **–ø–ª–∞—Ç–∞ –∑–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** (consistency). –ë–µ–∑ –Ω–µ–µ –±—ã–ª –±—ã –≤–æ–∑–º–æ–∂–µ–Ω –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤–∞–º–∏ race condition. –≠—Ç–æ —à—Ç–∞—Ç–Ω—ã–π –∏ –æ–∂–∏–¥–∞–µ–º—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã –ª—é–±–æ–π —Å–µ—Ä—å–µ–∑–Ω–æ–π –°–£–ë–î.

### –ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?

**–í –∞–±—Å–æ–ª—é—Ç–Ω–æ–º –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ ‚Äî –Ω–µ—Ç.** –ü–æ—á–µ–º—É:

*   **–í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** –û–ø–µ—Ä–∞—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É (–∏–Ω–¥–µ–∫—Å—É) ‚Äî –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ë–î.
*   **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º:** –¢–∞–∫ –∫–∞–∫ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ `eventId` (–¥—É–±–ª–∏), –∞ –æ–Ω–∏, –ø–æ –∏–¥–µ–µ, –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–¥–∫–æ, —Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –º–∞—Å—Å–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ `eventId` –Ω–µ –±—É–¥–µ—Ç –º–µ—à–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É.
*   **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –°–£–ë–î:** –ú–µ—Ö–∞–Ω–∏–∑–º—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ PostgreSQL –∏ –¥—Ä—É–≥–∏—Ö –°–£–ë–î –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–µ—Å—è—Ç–∏–ª–µ—Ç–∏—è–º–∏ –∏ –≤—ã–¥–µ—Ä–∂–∏–≤–∞—é—Ç –æ–≥—Ä–æ–º–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏.

### –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –¥—É–±–ª–µ–π –±—É–¥–µ—Ç –û–ß–ï–ù–¨ –º–Ω–æ–≥–æ?

–ï—Å–ª–∏ –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–æ–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ —Å–±–æ—è –ø—Ä–æ–¥—é—Å–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —à–ª–µ—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç—ã—Å—è—á–∏ —Ä–∞–∑), —Ç–æ —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—Å—Ç–∞–≤–∫—É –¥—É–±–ª–µ–π –Ω–∞—á–Ω—É—Ç "—Ç–æ–ª–ø–∏—Ç—å—Å—è" –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –∏–Ω–¥–µ–∫—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏.

**–ù–æ –≤ —ç—Ç–æ–º –µ—Å—Ç—å –∏ –ø–ª—é—Å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª—è –±—É–¥–µ—Ç –æ—á–µ–Ω—å –¥–µ—à–µ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–π `INSERT` –≤ –ë–î, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—è–∂–µ–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –¥–µ–Ω–µ–≥, –æ—Ç–ø—Ä–∞–≤–∫–∏ email –∏ —Ç.–¥.). –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ —Ç–∞–∫–∏–º –∞—Ç–∞–∫–∞–º.

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫? (–î–ª—è —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–æ–∫)

–ï—Å–ª–∏ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏ –≤–∞—à–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–∫–æ–≤–∞, —á—Ç–æ –¥–∞–∂–µ —ç—Ç–∏ –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π, –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –±–æ–ª–µ–µ —ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:

*   **Bloom-—Ñ–∏–ª—å—Ç—Ä—ã –≤ –ø–∞–º—è—Ç–∏:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ "–≤–æ–∑–º–æ–∂–Ω–æ –≤–∏–¥–µ–ª–∏" / "—Ç–æ—á–Ω–æ –Ω–µ –≤–∏–¥–µ–ª–∏". –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–æ –Ω–µ –¥–∞–µ—Ç 100% –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
*   **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis —Å –µ–≥–æ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ `SET key value NX` (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç). Redis –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –¥–ª—è —Ç–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

**–ù–æ –¥–ª—è 99.9% –ø—Ä–æ–µ–∫—Ç–æ–≤ `INSERT ... ON CONFLICT DO NOTHING` –≤ PostgreSQL ‚Äî —ç—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ–µ –ø–æ –ø—Ä–æ—Å—Ç–æ—Ç–µ, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ.**

**–ò—Ç–æ–≥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:** –í—ã –º–æ–∂–µ—Ç–µ confidently —Å–∫–∞–∑–∞—Ç—å: "–î–∞, –∑–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É—é—â–∏–π, –Ω–æ —ç—Ç–æ —Ç–æ—á–µ—á–Ω–∞—è –∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏. –≠—Ç–æ —à—Ç–∞—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –°–£–ë–î, –∏ –µ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á. –ü–ª–∞—Ç–∞ –∑–∞ —ç—Ç—É –º–∏–∫—Ä–æ-–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–µ—Å—Ä–∞–≤–Ω–∏–º–æ –Ω–∏–∂–µ, —á–µ–º —Ä–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–µ–π –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–∏."

[How to use `INSERT ON CONFLICT` to upsert data in PostgreSQL](https://www.prisma.io/dataguide/postgresql/inserting-and-modifying-data/insert-on-conflict)

---

–°–æ–±–µ—Ä–µ–º —ç—Ç–æ –≤ **–æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É-¬´—à–ø–∞—Ä–≥–∞–ª–∫—É¬ª** (–≤ –≤–∏–¥–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤/—Å—Ä–∞–≤–Ω–µ–Ω–∏–π), —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç –ø—Ä–æ–±–µ–∂–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∏–Ω—Ç–µ—Ä–≤—å—é.

---

üöÄ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è **—Ç–∞–±–ª–∏—Ü–∞-—à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ Kafka** ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–±–µ–∂–∞—Ç—å –≥–ª–∞–∑–∞–º–∏ –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ–º:

---

# üìù Kafka —à–ø–∞—Ä–≥–∞–ª–∫–∞ (–¥–ª—è —Å–æ–±–µ—Å–æ–≤)

| –¢–µ–º–∞                    | –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã                                                                                                                                                                              |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Topic**               | –õ–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π                                                                                                                                                                    |
| **Partition**           | ¬´–ü–æ–ª–æ—Å–∞¬ª –≤–Ω—É—Ç—Ä–∏ —Ç–æ–ø–∏–∫–∞, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è**                                                                                                                  |
| **Offset**              | –ü–æ–∑–∏—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ partition                                                                                                                                                                 |
| **Consumer Group**      | –°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ç–æ–ø–∏–∫–∞; **–æ–¥–Ω–∞ partition ‚Üí —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É consumer –≤ –≥—Ä—É–ø–ø–µ**                                                                                                                |
| **–ú–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**   | `min(#partitions, #consumers –≤ –≥—Ä—É–ø–ø–µ)`                                                                                                                                                       |
| **Producer (–æ—Ç–ø—Ä–∞–≤–∫–∞)** | - `acks=all` (–Ω–∞–¥—ë–∂–Ω–æ)<br>- `enable.idempotence=true` (–Ω–µ—Ç –¥—É–±–ª–µ–π)<br>- –∫–ª—é—á (`key`) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç partition                                                                                     |
| **Consumer (—á—Ç–µ–Ω–∏–µ)**   | - `enable-auto-commit=false` (–ª—É—á—à–µ —Ä—É—á–Ω–æ–π commit)<br>- `max.poll.records` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑<br>- `max.poll.interval.ms` ‚Äî —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏ –¥–æ–ª–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ                            |
| **Commit offset**       | - *at-most-once*: commit –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ—Ç–µ—Ä–∏)<br>- *at-least-once*: commit –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–¥—É–±–ª–∏ –≤–æ–∑–º–æ–∂–Ω—ã)<br>- *exactly-once*: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ—Ä–æ–≥–æ, —Ä–µ–¥–∫–æ)                                  |
| **–†–µ—Ç—Ä–∞–∏ –∏ –æ—à–∏–±–∫–∏**     | `DefaultErrorHandler` + `DeadLetterPublishingRecoverer` ‚Üí DLT (—Ç–æ–ø–∏–∫ –¥–ª—è ¬´–ø–ª–æ—Ö–∏—Ö¬ª —Å–æ–æ–±—â–µ–Ω–∏–π)                                                                                                  |
| **–ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π**   | - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π partition<br>- –ß—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Üí `key = userId`                                                                                                |
| **Rebalance**           | –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–∏—Å–ª–∞ consumers/partitions                                                                                                                         |
| **–ö–∞–∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å**  | - –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å partitions<br>- –ü–æ–¥–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à–µ consumers (–Ω–æ –Ω–µ –±–æ–ª—å—à–µ partitions)                                                                                                            |
| **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã** | - –î–æ–ª–≥–∏–µ –∑–∞–¥–∞—á–∏: <br/>–ª–∏–±–æ —É–≤–µ–ª–∏—á—å `max.poll.interval.ms`, <br/>–ª–∏–±–æ –≤—ã–Ω–µ—Å–∏ –≤ worker pool<br>- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–ª–∞–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (eventId, upsert)<br>- –ü–∞—Ä—Ç–∏—Ü–∏–π –ª—É—á—à–µ –∑–∞–¥–∞—Ç—å —Å –∑–∞–ø–∞—Å–æ–º (—É–º–µ–Ω—å—à–∏—Ç—å –Ω–µ–ª—å–∑—è) |

---

‚ö° **–°–≤–µ—Ä—Ö–∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Å–æ–±–µ—Å–∞**:

* *–ü–æ—á–µ–º—É UUID —É–Ω–∏–∫–∞–ª–µ–Ω?* ‚Üí 2¬π¬≤‚Å∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏ ‚âà 0.
* *–ß—Ç–æ –¥–∞—ë—Ç partition?* ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏.
* *–ö–∞–∫–æ–π –º–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º?* ‚Üí –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —á–∏—Å–ª–æ–º partitions.
* *–ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ userId?* ‚Üí key=userId.
* *–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –¥—É–±–ª—è–º–∏?* ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞.
* *–ß—Ç–æ —Ç–∞–∫–æ–µ rebalance?* ‚Üí –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ partitions –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã.

---


## üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ `max.poll.interval.ms`

* –≠—Ç–æ **consumer-side –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –∏–∑ Kafka).
* –û–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É –¥–≤—É–º—è –≤—ã–∑–æ–≤–∞–º–∏ `poll()`**.
* –ï—Å–ª–∏ consumer **—Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `poll()` —Å–Ω–æ–≤–∞, –±—Ä–æ–∫–µ—Ä —Å—á–∏—Ç–∞–µ—Ç –µ–≥–æ **¬´—É–ø–∞–≤—à–∏–º¬ª** –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç **rebalance** ‚Üí partition —É—Ö–æ–¥–∏—Ç –¥—Ä—É–≥–æ–º—É consumer.

üëâ –¢–æ –µ—Å—Ç—å, **–µ—Å–ª–∏ —É —Ç–µ–±—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ª–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 —Å–µ–∫, 1 –º–∏–Ω), –Ω–∞–¥–æ —É–≤–µ–ª–∏—á–∏—Ç—å `max.poll.interval.ms`, —á—Ç–æ–±—ã consumer –Ω–µ –≤—ã–ª–µ—Ç–∞–ª –∏–∑ –≥—Ä—É–ø–ø—ã.

---

## üîπ –î–ª—è –∫–æ–≥–æ —ç—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è

–≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä **Kafka consumer**, –∑–Ω–∞—á–∏—Ç:

* –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ö** (consumers).
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Spring Kafka ‚Üí `application.yaml` –∏–ª–∏ `ConsumerFactory`).

---

## üîπ –ö–∞–∫ –∑–∞–¥–∞—Ç—å –≤ `application.yaml`

–î–∞, –º–æ–∂–Ω–æ! –í Spring Boot –≤—Å—ë –ø—Ä–æ—Å—Ç–æ:

```yaml
spring:
  kafka:
    consumer:
      properties:
        max.poll.interval.ms: 600000   # 10 –º–∏–Ω—É—Ç
```

–∏–ª–∏ —á–µ—Ä–µ–∑ Java Config:

```java
props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 600000);
```

---

## üîπ –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å

* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `max.poll.interval.ms` **–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è heartbeat**.
  –ß—Ç–æ–±—ã consumer –Ω–µ –≤—ã–ø–∞–ª –∏–∑ –≥—Ä—É–ø–ø—ã, –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–ª–∞—Ç—å heartbeat (—á–µ—Ä–µ–∑ `heartbeat.interval.ms`) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ.
* –ù–æ –µ—Å–ª–∏ —Ç—ã ¬´–∑–∞–≤–∏—Å–Ω–µ—à—å¬ª –¥–æ–ª—å—à–µ, —á–µ–º `max.poll.interval.ms` –±–µ–∑ –≤—ã–∑–æ–≤–∞ `poll()` ‚Üí consumer —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞—Å—Ç—Ä—è–≤—à–∏–º, –∏–¥—ë—Ç —Ä–µ–±–∞–ª–∞–Ω—Å.

---

## üîπ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç

1. –ï—Å–ª–∏ —É —Ç–µ–±—è **–¥–æ–ª–≥–∏–µ —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Üí –ø–æ–¥–Ω–∏–º–∏ `max.poll.interval.ms` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 5‚Äì10 –º–∏–Ω—É—Ç).
2. –ï—Å–ª–∏ –º–æ–∂–Ω–æ ‚Äî **–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—É** –Ω–∞ —á–∞–Ω–∫–∏ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –±—ã—Å—Ç—Ä–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –¥—ë—Ä–≥–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä.
3. –ï—â—ë –ª—É—á—à–µ: –≤—ã–Ω–µ—Å–∏ —Ç—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ (worker pool), –∞ consumer —Ç–æ–ª—å–∫–æ **–±—ã—Å—Ç—Ä–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç offset**.

---

üìå –ù–∞ —Å–æ–±–µ—Å–µ —Ö–æ—Ä–æ—à–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–∞–∫:

> "`max.poll.interval.ms` ‚Äî —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ consumer, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É poll(). 
> –ï—Å–ª–∏ consumer –¥–æ–ª–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç poll, –æ–Ω –≤—ã–ø–∞–¥–µ—Ç –∏–∑ –≥—Ä—É–ø–ø—ã. –í Spring Boot —ç—Ç–æ –º–æ–∂–Ω–æ 
> –∑–∞–¥–∞—Ç—å –≤ `application.yaml` —á–µ—Ä–µ–∑ `spring.kafka.consumer.properties.max.poll.interval.ms`. –û–±—ã—á–Ω–æ –µ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç 
> –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ö –∏–ª–∏ –≤—ã–Ω–æ—Å—è—Ç —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤."

---

–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –≥–¥–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã **`max.poll.interval.ms`** –∏ **`max.poll.records`**, 
—á—Ç–æ–±—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ç—è–∂—ë–ª–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ.

---

–≠—Ç–∏ –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–∞–∫ —Ä–∞–∑ —á–∞—Å—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –≤–º–µ—Å—Ç–µ:

* **`max.poll.records`** ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π consumer –∑–∞–±–∏—Ä–∞–µ—Ç –∑–∞ –æ–¥–∏–Ω `poll()`.
* **`max.poll.interval.ms`** ‚Äî —Å–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ç–æ–π –ø–∞—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

–ò–¥–µ—è: –µ—Å–ª–∏ —É —Ç–µ–±—è —Ç—è–∂—ë–ª–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ 2‚Äì3 —Å–µ–∫—É–Ω–¥—ã), —Ç–æ:

* —É–º–µ–Ω—å—à–∏—Ç—å `max.poll.records`, —á—Ç–æ–±—ã –∑–∞ –æ–¥–∏–Ω `poll()` –Ω–µ —Ç—è–Ω—É—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ;
* —É–≤–µ–ª–∏—á–∏—Ç—å `max.poll.interval.ms`, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É –∏ –Ω–µ –≤—ã–ª–µ—Ç–µ—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã.

---

## üîπ –ü—Ä–∏–º–µ—Ä –≤ `application.yaml`

```yaml
spring:
  kafka:
    consumer:
      bootstrap-servers: localhost:9092
      group-id: heavy-worker
      enable-auto-commit: false
      auto-offset-reset: earliest
      properties:
        max.poll.records: 10         # –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 300000 # –¥–∞—ë–º –¥–æ 5 –º–∏–Ω—É—Ç –Ω–∞ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É
```

---

## üîπ Java-–∫–æ–Ω—Ñ–∏–≥ —Å ConsumerFactory

```java
@Configuration
@EnableKafka
public class KafkaConfig {

    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "heavy-worker");
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

        // üîë –Ω–∞—à–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 10);         // –º–µ–Ω—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 300000); // 5 –º–∏–Ω—É—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—á–∫–∏

        return new DefaultKafkaConsumerFactory<>(props, new StringDeserializer(), new StringDeserializer());
    }

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory());
        return factory;
    }
}
```

---

## üîπ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

–î–æ–ø—É—Å—Ç–∏–º:

* –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è ~2 —Å–µ–∫,
* –≤ –ø–∞—á–∫–µ (`max.poll.records = 10`) –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º—É–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π,
* –∑–Ω–∞—á–∏—Ç worst-case –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ = ~20 —Å–µ–∫.

–ú—ã –∑–∞–¥–∞–ª–∏ `max.poll.interval.ms = 300000` (5 –º–∏–Ω—É—Ç), —á—Ç–æ —Å –∑–∞–ø–∞—Å–æ–º –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π.

–ò –±—Ä–æ–∫–µ—Ä –Ω–µ –≤—ã–∫–∏–Ω–µ—Ç consumer –∏–∑ –≥—Ä—É–ø–ø—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω ¬´–∑–∞–¥–µ—Ä–∂–∞–ª—Å—è¬ª –Ω–∞ 20‚Äì30 —Å–µ–∫—É–Ω–¥.

---

üëâ –ù–∞ —Å–æ–±–µ—Å–µ —Ö–æ—Ä–æ—à–æ —Å–∫–∞–∑–∞—Ç—å —Ç–∞–∫:

> "–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å consumer –ø–æ–¥ —Ç—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –º—ã —É–º–µ–Ω—å—à–∞–µ–º `max.poll.records`, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑, 
> –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º `max.poll.interval.ms`, —á—Ç–æ–±—ã consumer —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É –∏ –Ω–µ –≤—ã–ø–∞—Å—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã. 
> –í Spring Boot —ç—Ç–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –ø—Ä—è–º–æ –≤ `application.yaml`."

---

# üìù –†–µ—Ü–µ–ø—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Kafka Consumer (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kafka consumer –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)

---

## 1. ‚ö° –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ª–µ–≥–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

* –¶–µ–ª—å: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞.
* –°–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è <100 –º—Å.

```yaml
spring:
  kafka:
    consumer:
      group-id: fast-worker
      enable-auto-commit: true      # –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∞–≤—Ç–æ-–∫–æ–º–º–∏—Ç
      properties:
        max.poll.records: 500       # –ø–æ–±–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 300000 # –¥–µ—Ñ–æ–ª—Ç (5 –º–∏–Ω) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
```

## üëâ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –º–µ—Ç—Ä–∏–∫, –ª—ë–≥–∫–∏—Ö –∏–≤–µ–Ω—Ç–æ–≤.

## 2. üõ† –¢—è–∂—ë–ª–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (CPU / DB –æ–ø–µ—Ä–∞—Ü–∏–∏)

* –¶–µ–ª—å: –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å consumer, –¥–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—á–∫—É.
* –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–µ–∫—É–Ω–¥—ã.

```yaml
spring:
  kafka:
    consumer:
      group-id: heavy-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 10          # –º–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
        max.poll.interval.ms: 600000  # 10 –º–∏–Ω—É—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–∞—á–∫–∏
```

### üëâ –•–æ—Ä–æ—à–æ –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å—á—ë—Ç –æ—Ç—á—ë—Ç–æ–≤, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã).

## 3. üì¶ –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (bulk)

* –¶–µ–ª—å: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î / API.

```yaml
spring:
  kafka:
    listener:
      type: batch                   # –≤–∫–ª—é—á–∞–µ–º –±–∞—Ç—á-–ª–∏—Å—Ç–µ–Ω–µ—Ä
    consumer:
      group-id: batch-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 100       # –±–µ—Ä—ë–º –ø–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
        max.poll.interval.ms: 300000
```

–ö–æ–¥:

```java
@KafkaListener(topics = "events", containerFactory = "batchFactory")
public void listen(List<ConsumerRecord<String, String>> records) {
    // –ø–∞—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    bulkInsert(records.stream().map(ConsumerRecord::value).toList());
}
```

üëâ –ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –≤—ã–≥–æ–¥–Ω–µ–µ –ø–∏—Å–∞—Ç—å –≤ –ë–î/–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å API **—Å—Ä–∞–∑—É –ø–∞—á–∫–æ–π**.

---

## 4. üîÑ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (worker pool)

* –¶–µ–ª—å: consumer –±—ã—Å—Ç—Ä–æ ¬´–≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç¬ª —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ —Ç—è–∂—ë–ª–∞—è —Ä–∞–±–æ—Ç–∞ —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤.

```yaml
spring:
  kafka:
    consumer:
      group-id: async-worker
      enable-auto-commit: false
      properties:
        max.poll.records: 50
        max.poll.interval.ms: 600000
```

–ö–æ–¥:

```java
@Service
class AsyncListener {

    private final ExecutorService pool = Executors.newFixedThreadPool(10);

    @KafkaListener(topics = "orders", concurrency = "3")
    public void listen(ConsumerRecord<String, String> rec, Acknowledgment ack) {
        pool.submit(() -> {
            try {
                process(rec.value()); // —Ç—è–∂—ë–ª–∞—è —Ä–∞–±–æ—Ç–∞
                ack.acknowledge();
            } catch (Exception e) {
                // retry / dlt
            }
        });
    }
}
```

üëâ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –∑–∞–¥–∞—á, –≥–¥–µ –Ω—É–∂–Ω–æ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å throughput.

---

## 5. ‚ùå –†–∞–±–æ—Ç–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –∏ DLT

* –¶–µ–ª—å: –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫.

```java
@Bean
public DefaultErrorHandler errorHandler(KafkaTemplate<Object, Object> template) {
    var recoverer = new DeadLetterPublishingRecoverer(template);
    var backOff = new FixedBackOff(2000L, 3L);          // 3 —Ä–µ—Ç—Ä–∞—è —Å –ø–∞—É–∑–æ–π 2 —Å–µ–∫
    return new DefaultErrorHandler(recoverer, backOff);
}
```

üëâ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –≤ **Dead Letter Topic** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `orders.DLT`).

---

# üìå –ö—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–æ–º

1. **–õ—ë–≥–∫–∏–µ –∑–∞–¥–∞—á–∏** ‚Üí `max.poll.records` –ø–æ–±–æ–ª—å—à–µ, –º–æ–∂–Ω–æ –∞–≤—Ç–æ-–∫–æ–º–º–∏—Ç.
2. **–¢—è–∂—ë–ª—ã–µ –∑–∞–¥–∞—á–∏** ‚Üí `max.poll.records` —É–º–µ–Ω—å—à–∏—Ç—å, `max.poll.interval.ms` —É–≤–µ–ª–∏—á–∏—Ç—å.
3. **–ë–∞—Ç—á–∏** ‚Üí `listener.type=batch` + `max.poll.records` –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏.
4. **Worker pool** ‚Üí consumer –±—ã—Å—Ç—Ä–æ —Ç—è–Ω–µ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Ö–æ–¥–∏—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏.
5. **–û—à–∏–±–∫–∏** ‚Üí DefaultErrorHandler + DLT, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.

---

üôå –¢—ã –æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞—Ü–µ–ø–∏–ª—Å—è: –≤ Spring Kafka –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è

```java
@KafkaListener(concurrency = "6")
```

–æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –¥–æ 6 consumer-–ø–æ—Ç–æ–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
üëâ –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ **–æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è `onMessage` –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤**.

---

## üîπ –ß—Ç–æ –∑–Ω–∞—á–∏—Ç ¬´–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º¬ª –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ?

–†–µ—á—å –ø—Ä–æ –≤—Å—ë, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ `onMessage` –∏ –Ω–∏–∂–µ –ø–æ –≤—ã–∑–æ–≤–∞–º**.

* –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–æ–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã** (—Å–ø–∏—Å–æ–∫, Map, –∫–µ—à, —Å—á—ë—Ç—á–∏–∫, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ), –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã:

    * `ConcurrentHashMap`, `AtomicInteger`, `CopyOnWriteArrayList`, `ReentrantLock` –∏ —Ç.–ø.
* –ï—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë–î –∏–ª–∏ REST), –ø—Ä–æ–±–ª–µ–º –æ–±—ã—á–Ω–æ –Ω–µ—Ç ‚Äî –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω.
* –ï—Å–ª–∏ –º–µ—Ç–æ–¥ **–º—É—Ç–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∏–Ω–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É), —Ç–æ —ç—Ç–æ —É–∂–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.

---

## üîπ –ü—Ä–∏–º–µ—Ä *–Ω–µ–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ* –∫–æ–¥–∞

```java
@Service
class BadListener {
    private final List<String> buffer = new ArrayList<>(); // –æ–±—ã—á–Ω—ã–π ArrayList –Ω–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω!

    @KafkaListener(topics = "orders", concurrency = "6")
    public void onMessage(ConsumerRecord<String, String> rec) {
        buffer.add(rec.value());                // üí• –≥–æ–Ω–∫–∏ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
    }
}
```

---

## üîπ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:

```java
@Service
class GoodListener {
    private final List<String> buffer = Collections.synchronizedList(new ArrayList<>());

    @KafkaListener(topics = "orders", concurrency = "6")
    public void onMessage(ConsumerRecord<String, String> rec) {
        buffer.add(rec.value());                // ‚úÖ —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ
    }
}
```

–∏–ª–∏:

```java
@Service
class BetterListener {
    private final Queue<String> buffer = new ConcurrentLinkedQueue<>();

    @KafkaListener(topics = "orders", concurrency = "6")
    public void onMessage(ConsumerRecord<String, String> rec) {
        buffer.add(rec.value());                // ‚úÖ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    }
}
```

---

## üîπ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫

`concurrency > 1` = —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö partitions –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
–ù–æ **–ø–æ—Ä—è–¥–æ–∫ –¥–ª—è –æ–¥–Ω–æ–≥–æ `key`** Kafka –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π partition ‚Üí –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏,
–µ—Å–ª–∏ **–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–Ω—É partition**.

–¢—É—Ç –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–µ –æ ¬´—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞¬ª, –∞ –æ —Ç–æ–º, —á—Ç–æ–±—ã —Ç–≤–æ–π –∫–æ–¥ –Ω–µ —Å–ª–æ–º–∞–ª—Å—è –∏–∑-–∑–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.

---

üìå –ù–∞ —Å–æ–±–µ—Å–µ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —Ç–∞–∫:

> ¬´–ö–æ–≥–¥–∞ —è –∑–∞–¥–∞—é `concurrency` –≤ Spring Kafka, –º–µ—Ç–æ–¥ `@KafkaListener` –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö. 
> –ü–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ –æ–±—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 
> –æ–±—ã—á–Ω—ã–π ArrayList –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ConcurrentHashMap, synchronizedList –∏–ª–∏ –≤—ã–Ω–æ—Å–∏—Ç—å —Ç—è–∂—ë–ª—É—é —Ä–∞–±–æ—Ç—É 
> –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ worker-–ø—É–ª—ã¬ª.

---
 
**–ú–∞–ª–µ–Ω—å–∫–∏–π —Å–ø–∏—Å–æ–∫ ¬´–ø—Ä–∞–≤–∏–ª –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ KafkaListener¬ª** (—á—Ç–æ –º–æ–∂–Ω–æ/–Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞), —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è

---

# ‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ `@KafkaListener`

---

## 1. –û–±—â–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

‚ùå **–ù–µ–ª—å–∑—è**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–µ `ArrayList`, `HashMap`, `HashSet` –∏ —Ç.–ø. –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –≤ –Ω–∏—Ö –ø–∏—à—É—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤.

‚úî **–ú–æ–∂–Ω–æ**:

* `ConcurrentHashMap`, `ConcurrentLinkedQueue`, `CopyOnWriteArrayList`
* `AtomicInteger`, `AtomicLong` –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤
* `synchronizedList` / `synchronizedMap` (–µ—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤—ã—Å–æ–∫–∞—è)

---

## 2. –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ë–î, REST)

* –û–±—ã—á–Ω–æ **–±–µ–∑–æ–ø–∞—Å–Ω–æ**, —Ç.–∫. –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω.
* –ù–æ:

    * –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (JDBC/Hikari, HTTP-–∫–ª–∏–µ–Ω—Ç) ‚Üí –æ–Ω–∏ —Å–∞–º–∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ.
    * –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —à–∞—Ä–∏—Ç—Å—è –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–≥–æ–ª—ã–π¬ª JDBC `Connection`) ‚Üí —ç—Ç–æ –æ–ø–∞—Å–Ω–æ!

---

## 3. –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∏–Ω–∞

‚ùå **–ü–ª–æ—Ö–æ**:

```java
private String lastMessage; // –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ç–∏—Ä–∞—Ç—å—Å—è –ø–æ—Ç–æ–∫–∞–º–∏
```

‚úî **–•–æ—Ä–æ—à–æ**:

* –ò–∑–±–µ–≥–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è mutable state –≤ Listener.
* –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `AtomicReference`, `volatile` –∏–ª–∏ `synchronized` –¥–æ—Å—Ç—É–ø.

---

## 4. –†–∞–±–æ—Ç–∞ —Å –ø–æ—Ä—è–¥–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π

* Kafka **—Å–∞–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤–Ω—É—Ç—Ä–∏ partition**.
* –¢–≤–æ—è –∑–∞–¥–∞—á–∞: **–Ω–µ –ø–µ—Ä–µ–º–µ—à–∞—Ç—å** —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∞–ª—å—à–µ –≤ –∫–æ–¥–µ.
  ‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–¥–Ω–æ–≥–æ partition –≤ –æ–±—â–∏–π `ExecutorService` –±–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–∏–Ω–∞—á–µ –Ω–∞—Ä—É—à–∏—à—å –ø–æ—Ä—è–¥–æ–∫).
  ‚úî –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É ‚Üí –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å worker pool, –Ω–æ **–∫–ª—é—á–µ–≤–∞—Ç—å (–∑–∞–¥–∞–≤–∞—Ç—å –∫–ª—é—á–∏) –∑–∞–¥–∞—á–∏ –ø–æ partition/key**.

---

## 5. Error handling –∏ —Ä–µ—Ç—Ä–∞–∏

* –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–∑–æ–≤–µ**.
* –ï—Å–ª–∏ —Ö—Ä–∞–Ω–∏—à—å ¬´—Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫¬ª ‚Üí –¥–µ–ª–∞–π –µ–≥–æ –∞—Ç–æ–º–∞—Ä–Ω—ã–º (`AtomicInteger`).
* –î–ª—è —Ä–µ—Ç—Ä–∞–µ–≤ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Spring Kafka DefaultErrorHandler + DLT**, –∞ –Ω–µ —Å–∞–º–æ–ø–∏—Å–Ω—ã–µ —Å–ø–∏—Å–∫–∏.

---

## 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏

* –õ–æ–≥–≥–µ—Ä—ã (SLF4J/Logback/Log4j) –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã ‚Üí –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ `log.info(...)` –±–µ–∑ –ø—Ä–æ–±–ª–µ–º.
* –° –º–µ—Ç—Ä–∏–∫–∞–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞—Ç–æ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, Micrometer —Å–∞–º –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π).

---

# üìå –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–∏–Ω—Ü–∏–ø

* **–ù–µ —Ö—Ä–∞–Ω–∏—Ç—å mutable state –≤ Listener.**
* –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å thread-safe –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç–∏–ø—ã.
* –í—Å—ë —Ç—è–∂—ë–ª–æ–µ ‚Üí –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π worker pool, –Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø–æ—Ä—è–¥–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∫–ª—é—á—É.

---

–ü—Ä–∏–º–µ—Ä **¬´–ø–ª–æ—Ö–æ–≥–æ¬ª Listener –∏ ¬´—Ö–æ—Ä–æ—à–µ–≥–æ¬ª Listener** —Ä—è–¥–æ–º, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ä–∞–∑–Ω–∏—Ü—É.
–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –Ω–∞–≥–ª—è–¥–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã. –ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

### 1. ¬´–ü–ª–æ—Ö–æ–π¬ª (–ü–æ—Ç–æ–∫–æ-–ù–ï–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) Listener

–≠—Ç–æ—Ç –ª–∏—Å—Çener –ø–æ–ª–æ–Ω –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ –Ω–æ–≤–∏—á–∫–æ–≤.

```kotlin
import org.springframework.kafka.annotation.KafkaListener
import org.springframework.stereotype.Component
import java.util.concurrent.ConcurrentHashMap

@Component
class BadPaymentListener(
    private val userService: UserService // (–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –æ–Ω –Ω–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω)
) {

    // ‚ùå –û–ü–ê–°–ù–û: –û–±—â–µ–µ mutable —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏!
    private val processedEvents = mutableSetOf<String>()

    // ‚ùå –û–ü–ê–°–ù–û: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    private val userLocks = ConcurrentHashMap<String, Any>()
    private val defaultLock = Any()

    @KafkaListener(topics = ["payments"])
    fun handleBadEvent(event: PaymentEvent) {

        // ‚ùå –û–®–ò–ë–ö–ê: –ù–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–µ —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è again.
        // userService.deposit(event.userId, event.amount)

        // ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω—ã!
        // –ú–µ–∂–¥—É contains –∏ add –º–æ–∂–µ—Ç –≤–ª–µ–∑—Ç—å –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫.
        if (processedEvents.contains(event.eventId)) {
            println("–î—É–±–ª—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º: ${event.eventId}")
            return
        }
        processedEvents.add(event.eventId) // –¢–µ–ø–µ—Ä—å –æ–±–∞ –ø–æ—Ç–æ–∫–∞ –¥–æ–±–∞–≤—è—Ç —Å–≤–æ–π eventId

        // ‚ùå –°–õ–û–ñ–ù–´–ô –ò –û–ü–ê–°–ù–´–ô –ö–û–î: –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø–æ userId
        val userLock = userLocks.getOrPut(event.userId) { Object() }
        synchronized(userLock) { // ‚ö†Ô∏è –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ deadlock –ø–æ–ª—É—á–∏—Ç—å
            userService.deposit(event.userId, event.amount)
        }

        // ‚ùå –û–®–ò–ë–ö–ê: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π. –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å —É–ø–∞–¥–µ—Ç –∏ offset –Ω–µ –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—Å—è.
        // ‚ùå –û–®–ò–ë–ö–ê: –ù–µ—Ç —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è offset. –ü–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –Ω–∞–¥–æ–ª–≥–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ synchronized.
    }
}
```

**–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã ¬´–ø–ª–æ—Ö–æ–≥–æ¬ª –ª–∏—Å—Ç–µ–Ω–µ—Ä–∞:**
1.  **Race Condition:** –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ `check-then-act` (`contains` -> `add`) –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
2.  **–û–±—â–µ–µ mutable —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** `processedEvents` –∏ `userLocks` ‚Äî –æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Ö –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –≤–µ–¥–µ—Ç –∫ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.
3.  **–°–∞–º–æ–¥–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:** –û—á–µ–Ω—å –ª–µ–≥–∫–æ –æ—à–∏–±–∏—Ç—å—Å—è –∏ —Å–æ–∑–¥–∞—Ç—å deadlock.
4.  **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:** –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –±–æ—Ä—å–±—ã —Å –¥—É–±–ª—è–º–∏.
5.  **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:** –õ—é–±–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —É–±—å—ë—Ç –∫–æ–Ω—Å—å—é–º–µ—Ä.
6.  **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** `synchronized` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ü–µ–ª—ã–π –ø–æ—Ç–æ–∫ –Ω–∞–¥–æ–ª–≥–æ.

---

### 2. ¬´–•–æ—Ä–æ—à–∏–π¬ª (–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) Listener

–≠—Ç–æ—Ç –ª–∏—Å—Çener –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Spring.

```kotlin
import org.springframework.kafka.annotation.KafkaListener
import org.springframework.stereotype.Component
import org.springframework.transaction.annotation.Transactional

@Component
class GoodPaymentListener(
    private val userService: UserService,
    private val processedEventRepository: ProcessedEventRepository // –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
) {

    // ‚úÖ –•–û–†–û–®–û: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–µ mutable —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ thread-safe —Å–µ—Ä–≤–∏—Å—ã –∏ –ë–î.

    @KafkaListener(
        topics = ["payments"],
        concurrency = "3", // ‚úÖ –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
        containerFactory = "kafkaListenerContainerFactory" // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–∞–±—Ä–∏–∫—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    )
    @Transactional // ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π –¥–ª—è –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π
    fun handleGoodEvent(event: PaymentEvent) {

        // ‚úÖ –ò–î–ï–ú–ü–û–¢–ï–ù–¢–ù–û–°–¢–¨: –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø–∏—Å—å eventId –≤ –ë–î
        val isDuplicate = processedEventRepository.tryInsertEventId(event.eventId)
        if (isDuplicate) {
            logger.warn("Duplicate event ${event.eventId} detected. Skipping.")
            return
        }

        // ‚úÖ –ü–û–¢–û–ö–û–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (SELECT FOR UPDATE) –∏–ª–∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        // —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –í–ù–£–¢–†–ò —Å–µ—Ä–≤–∏—Å–∞ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –õ–∏—Å—Ç–µ–Ω–µ—Ä –æ–± —ç—Ç–æ–º –Ω–µ –∑–Ω–∞–µ—Ç.
        try {
            userService.depositMoney(event.userId, event.amount)
        } catch (e: Exception) {
            // ‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö: –õ–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –ª–æ–≥–∏—Ä—É–µ–º –µ–≥–æ.
            // –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –Ω–µ —É–ø–∞–¥–µ—Ç, offset –Ω–µ –±—É–¥–µ—Ç –∑–∞–∫–æ–º–º–∏—á–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è,
            // –∏ –æ–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—å –≤—ã—à–µ).
            logger.error("Failed to process payment event: ${event.eventId}", e)
            throw e // ‚úÖ –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Kafka –µ–≥–æ —É–≤–∏–¥–µ–ª –∏ –æ—Ç–∫–∞—Ç–∏–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        }
    }
}
```

**–ê –≤–æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ —Å–µ—Ä–≤–∏—Å–∞:**

```kotlin
// ProcessedEventRepository.kt
@Repository
class ProcessedEventRepository(private val jdbcTemplate: JdbcTemplate) {
    fun tryInsertEventId(eventId: String): Boolean {
        // ‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –û–ü–ï–†–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ –ë–î
        val rowsAffected = jdbcTemplate.update(
            """
            INSERT INTO processed_events (event_id) 
            VALUES (?) 
            ON CONFLICT (event_id) DO NOTHING
            """,
            eventId
        )
        return rowsAffected == 0
    }
}

// UserService.kt
@Service
@Transactional // ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
class UserService(private val userRepository: UserRepository) {

    fun depositMoney(userId: String, amount: BigDecimal) {
        // ‚úÖ –ü–û–¢–û–ö–û–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
        val user = userRepository.findByUserIdWithLock(userId)
            ?: throw IllegalArgumentException("User not found: $userId")

        user.balance += amount
        userRepository.save(user) // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    }
}

// UserRepository.kt
interface UserRepository : JpaRepository<User, String> {
    // ‚úÖ –Ø–≤–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ç—Ä–æ–∫–∏ –≤ –ë–î –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    @Query("SELECT u FROM User u WHERE u.id = :userId")
    @Lock(LockModeType.PESSIMISTIC_WRITE) // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ "FOR UPDATE"
    fun findByUserIdWithLock(@Param("userId") userId: String): User?
}
```

---

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–ª–∏—á–∏–π

| –ê—Å–ø–µ–∫—Ç | ¬´–ü–ª–æ—Ö–æ–π¬ª Listener | ¬´–•–æ—Ä–æ—à–∏–π¬ª Listener |
| :--- | :--- | :--- |
| **–°–æ—Å—Ç–æ—è–Ω–∏–µ** | –û–±—â–µ–µ `MutableState` –≤ –ø–∞–º—è—Ç–∏ | Stateless, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î |
| **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | –ù–µ—Ç –∏–ª–∏ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è | –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ë–î |
| **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏** | `synchronized`, —Å–∞–º–æ–¥–µ–ª—å–Ω—ã–µ `Lock` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (`SELECT ... FOR UPDATE`) |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, consumer –ø–∞–¥–∞–µ—Ç | –ï—Å—Ç—å, –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, offset –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è |
| **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | –ù–µ—Ç, race condition | –î–∞, –∑–∞ —Å—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è (–∏–∑-–∑–∞ —Å–∞–º–æ–¥–µ–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤) | –ù–∏–∑–∫–∞—è (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Spring –∏ –ë–î) |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è (–±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ –Ω–∞ `synchronized`) | –í—ã—Å–æ–∫–∞—è (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ë–î —Ç–æ—á–µ—á–Ω—ã–µ) |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ offset** | –ù–µ—è–≤–Ω–æ–µ, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–æ | –Ø–≤–Ω–æ–µ –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ–≤—Ç–æ—Ä–æ–≤ |

**–í—ã–≤–æ–¥:** ¬´–•–æ—Ä–æ—à–∏–π¬ª –ª–∏—Å—Ç–µ–Ω–µ—Ä **–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –ë–î –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã Spring** –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞, 
  –∞ –Ω–µ –∏–∑–æ–±—Ä–µ—Ç–∞–µ—Ç —Å–≤–æ–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –∫–æ–¥ –ø—Ä–æ—â–µ, –Ω–∞–¥–µ–∂–Ω–µ–µ –∏ –ª–µ–≥—á–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏.

---

–°–ø–∞—Å–∏–±–æ! –¢—ã –º–Ω–µ –ø–æ–∫–∞–∑–∞–ª –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π –ø—Ä–∏–º–µ—Ä –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø–∏—Å–∏ eventId –≤ –ë–î, –∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–ø–∏—Å—å –≤ –ë–î. –∫–∞–∫ —è –ø–æ–Ω—è–ª, —ç—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –ë–î, —Ç–∞–∫? –ê –µ—Å—Ç—å –µ—â–µ NoSql –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –æ–Ω–∏ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è? Mongo? Redis?

---

–û—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í—ã –≤—ã—à–ª–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–Ω–∏–º–∞–Ω–∏—è ‚Äî –≤—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–¥ –∑–∞–¥–∞—á—É. **–î–∞, —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –ë–î, –∏ —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NoSQL –±–∞–∑—ã, –Ω–æ —Å –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏.**

–ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–π –∂–µ: **–Ω—É–∂–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å"**, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∞–º–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö.

---

### 1. Redis (–ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–µ—à–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–µ–π)

Redis ‚Äî –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ç–∞–∫–æ–π –∑–∞–¥–∞—á–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ.

**–ü–∞—Ç—Ç–µ—Ä–Ω: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `SET` —Å –æ–ø—Ü–∏—è–º–∏ `NX` (Not eXists) –∏ `EX` (Expire).**

```kotlin
import org.springframework.data.redis.core.RedisTemplate
import org.springframework.stereotype.Repository
import java.util.concurrent.TimeUnit

@Repository
class RedisProcessedEventRepository(
    private val redisTemplate: RedisTemplate<String, String>
) {

    fun tryInsertEventId(eventId: UUID, ttlMinutes: Long = 60): Boolean {
        // –ö–ª—é—á –¥–ª—è Redis
        val redisKey = "processed_event:$eventId"

        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ. –ö–æ–º–∞–Ω–¥–∞ SET —Å NX –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ê–¢–û–ú–ê–†–ù–û.
        // –û–Ω–∞ –≤–µ—Ä–Ω–µ—Ç true, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ (—Ç.–µ. —Å–æ–±—ã—Ç–∏—è –Ω–µ –±—ã–ª–æ).
        val wasSet = redisTemplate.opsForValue().setIfAbsent(redisKey, "processed")

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞ (—á—Ç–æ–±—ã Redis –ø–æ—á–∏—Å—Ç–∏–ª —Å—Ç–∞—Ä—ã–µ eventId)
        if (wasSet != null && wasSet) {
            redisTemplate.expire(redisKey, ttlMinutes, TimeUnit.MINUTES)
            return false // –ù–µ –¥—É–±–ª—å (—Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø–∏—Å–∞–ª–∏)
        }
        return true // –î—É–±–ª—å (–∫–ª—é—á —É–∂–µ –±—ã–ª)
    }
}
```

**–ü–ª—é—Å—ã:**
*   **–°–≤–µ—Ä—Ö—Å–∫–æ—Ä–æ—Å—Ç—å.** –û–ø–µ—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏.
*   **–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TTL.** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π ‚Äî –Ω–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —á–∏—Å—Ç–∫—É.
*   **–ü—Ä–æ—Å—Ç–æ—Ç–∞.**

**–ú–∏–Ω—É—Å—ã:**
*   **–î–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ—Å—Ç–æ—è–Ω–Ω—ã.** –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ Redis –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –ø—Ä–æ–ø–∞–¥—É—Ç. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ –º–∏–Ω—É—Å–æ–º (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö), —Ç–∞–∫ –∏ –ø–ª—é—Å–æ–º (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Å–±–æ—è).
*   **–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞—É–¥–∏—Ç–∞.** –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π forever, Redis –Ω–µ –ª—É—á—à–∏–π –≤—ã–±–æ—Ä.

**–ò–¥–µ–∞–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–∞–∫–æ–≥–æ-—Ç–æ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å–∞, –¥–Ω—è), –≥–¥–µ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞.

---

### 2. MongoDB (–î–æ–∫—É–º–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ë–î)

–í Mongo —Ç–æ–∂–µ –µ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã.

**–®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å.**
```kotlin
// Document-—Å—É—â–Ω–æ—Å—Ç—å
@Document(collection = "processedEvents")
data class ProcessedEvent(
    @Id val id: String? = null, // Id –¥–æ–∫—É–º–µ–Ω—Ç–∞ Mongo
    val eventId: String, // –ù–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π eventId
    val processedAt: Instant = Instant.now()
)
```

**–®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ –ø–æ–ª–µ `eventId`** (—á–µ—Ä–µ–∑ `@Indexed` –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤ –ë–î).

**–®–∞–≥ 3: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.**
```kotlin
import org.springframework.data.mongodb.core.MongoTemplate
import org.springframework.data.mongodb.core.query.Criteria
import org.springframework.data.mongodb.core.query.Query
import org.springframework.data.mongodb.core.query.Update
import org.springframework.data.mongodb.core.FindAndModifyOptions

@Repository
class MongoProcessedEventRepository(
    private val mongoTemplate: MongoTemplate
) {

    fun tryInsertEventId(eventId: UUID): Boolean {

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å —Ç–∞–∫–∏–º eventId
        val query = Query.query(Criteria.where("eventId").`is`(eventId.toString()))

        // –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π)
        val update = Update().setOnInsert("processedAt", Instant.now())

        val options = FindAndModifyOptions.options().returnNew(false).upsert(true)

        // –ê–¢–û–ú–ê–†–ù–ê–Ø –æ–ø–µ—Ä–∞—Ü–∏—è: –Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å (upsert)
        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è (upsert) - –∑–Ω–∞—á–∏—Ç, —Å–æ–±—ã—Ç–∏—è –Ω–µ –±—ã–ª–æ.
        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è - –∑–Ω–∞—á–∏—Ç, —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å.
        try {
            val result = mongoTemplate.findAndModify(query, update, options, ProcessedEvent::class.java)
            // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç null - –¥–æ–∫—É–º–µ–Ω—Ç –±—ã–ª –≤—Å—Ç–∞–≤–ª–µ–Ω (–Ω–µ –¥—É–±–ª—å)
            // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ null - –¥–æ–∫—É–º–µ–Ω—Ç –±—ã–ª –Ω–∞–π–¥–µ–Ω (–¥—É–±–ª—å)
            return result != null
        } catch (e: DuplicateKeyException) {
            // –ï—Å–ª–∏ –≤ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É—Å–ø–µ–ª –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–∫–æ–π –∂–µ eventId,
            // Mongo –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –æ –¥—É–±–ª–∏–∫–∞—Ç–µ –∫–ª—é—á–∞ -> –¥–ª—è –Ω–∞—Å —ç—Ç–æ –¥—É–±–ª—å.
            return true
        }
    }
}
```

**–ü–ª—é—Å—ã:**
*   **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ.** –î–∞–Ω–Ω—ã–µ –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–Ω—É—Ç—Å—è.
*   **–ì–∏–±–∫–æ—Å—Ç—å.** –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ –ø–æ–ª—è –¥–ª—è –∞—É–¥–∏—Ç–∞ (`processedAt`, `source` –∏ —Ç.–¥.).

**–ú–∏–Ω—É—Å—ã:**
*   **–°–ª–æ–∂–Ω–µ–µ, —á–µ–º –≤ Redis.** –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
*   **–ú–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º Redis,** –Ω–æ –æ–±—ã—á–Ω–æ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ –ë–î.

---

### 3. Apache Cassandra (Column-Family –ë–î)

Cassandra —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –Ω–æ –ø—Ä–∏–Ω—Ü–∏–ø —Ç–æ—Ç –∂–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã.

**–ü–∞—Ç—Ç–µ—Ä–Ω: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Lightweight Transactions (LWT) —Å —É—Å–ª–æ–≤–∏–µ–º `IF NOT EXISTS`.**

```sql
-- –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE processed_events (
    event_id text PRIMARY KEY,
    processed_at timestamp
);
```

```kotlin
import com.datastax.oss.driver.api.core.CqlSession
import com.datastax.oss.driver.api.core.cql.SimpleStatement
import java.time.Instant

@Repository
class CassandraProcessedEventRepository(
    private val session: CqlSession
) {

    fun tryInsertEventId(eventId: UUID): Boolean {
        // –ó–∞–ø—Ä–æ—Å —Å —É—Å–ª–æ–≤–∏–µ–º "IF NOT EXISTS" –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Cassandra.
        val query = """
            INSERT INTO processed_events (event_id, processed_at) 
            VALUES (?, ?) 
            IF NOT EXISTS
        """.trimIndent()

        val statement = SimpleStatement.builder(query)
            .addPositionalValue(eventId.toString())
            .addPositionalValue(Instant.now())
            .build()

        val resultSet = session.execute(statement)
        // ResultSet —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏—è.
        // –ü–æ–ª–µ '[applied]' –±—É–¥–µ—Ç true, –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ—à–ª–∞ (–Ω–µ –¥—É–±–ª—å).
        return !resultSet.one().getBool("[applied]")
    }
}
```

**–ü–ª—é—Å—ã:** –û—Ç–ª–∏—á–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏.
**–ú–∏–Ω—É—Å—ã:** LWT ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å –¥–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è Cassandra, –∏—Ö —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.

---

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: –ö–∞–∫—É—é –ë–î –≤—ã–±—Ä–∞—Ç—å?

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è (Postgres) | Redis | MongoDB | Cassandra (LWT) |
| :--- | :--- | :--- | :--- | :--- |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–æ | **–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ** | –ë—ã—Å—Ç—Ä–æ | –ú–µ–¥–ª–µ–Ω–Ω–æ (–¥–ª—è LWT) |
| **–ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ** | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç (–∏–ª–∏ —Å–Ω–∏–º–∫–∏) | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** | `INSERT ON CONFLICT` | `SET NX` | `upsert` / –ò–Ω–¥–µ–∫—Å—ã | `IF NOT EXISTS` |
| **TTL** | ‚ùå (–ù—É–∂–Ω–æ —á–∏—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é) | ‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π** | ‚úÖ (–ï—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π) | ‚úÖ (–ï—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π) |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | **–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| **–ò–¥–µ–∞–ª—å–Ω—ã–π –∫–µ–π—Å** | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∞—É–¥–∏—Ç | –ö–µ—à –¥—É–±–ª–µ–π, –≤—ã—Å–æ—á–∞–π—à–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å | –ì–∏–±–∫–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∞—É–¥–∏—Ç | –û—á–µ–Ω—å –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö |

**–í—ã–≤–æ–¥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:** 
>"–ö–æ–Ω–µ—á–Ω–æ, –ø–∞—Ç—Ç–µ—Ä–Ω —Å –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –≤—Å—Ç–∞–≤–∫–æ–π `eventId` –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –ë–î, –Ω–æ –∏ —Å NoSQL. 
>–í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞. –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –µ—Å–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º–∞ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö ‚Äî –∏–¥–µ–∞–ª–µ–Ω Redis —Å 
> –µ–≥–æ `SET NX`. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≥–∏–±–∫–æ—Å—Ç—å ‚Äî –ø–æ–¥–æ–π–¥–µ—Ç MongoDB —Å `upsert` –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏. –†–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–µ –ë–î, 
> –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π, –Ω–∞–¥–µ–∂–Ω—ã–π –∏ —Ö–æ—Ä–æ—à–æ –ø–æ–Ω—è—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ `INSERT ON CONFLICT`."

---

Redis –º–æ–∂–µ—Ç –≤—ã—Å—Ç—É–ø–∞—Ç—å –≤ —Ä–æ–ª–∏ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —à–∞–±–ª–æ–Ω—É –ø—É–±–ª–∏–∫–∞—Ü–∏—è-–ø–æ–¥–ø–∏—Å–∫–∞. –í Redis —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º Pub/Sub, 
–ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª—ã (topics) –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–∏—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Redis Pub/Sub –∫–∞–∫ –±—Ä–æ–∫–µ—Ä–∞:
- –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –Ω–∞ –∫–∞–Ω–∞–ª –≤ –º–æ–º–µ–Ω—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
- –ï—Å–ª–∏ –≤ –º–æ–º–µ–Ω—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.
- Redis Pub/Sub –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–æ–±—ã—Ç–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —á–∞—Ç–æ–≤, –≥–¥–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø–æ—Ç–µ—Ä—è —Å–æ–æ–±—â–µ–Ω–∏–π.
- –ú–æ–¥–µ–ª—å –ø—Ä–æ—â–µ –∏ –ª–µ–≥—á–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —á–µ–º Kafka, –Ω–æ –Ω–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
- –î–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π Redis –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥—Ä—É–≥—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö ‚Äî Streams, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Ö–æ–∂–∞ –Ω–∞ –æ—á–µ—Ä–µ–¥—å 
  —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, Redis –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è pub/sub, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞, –∞ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –¥–æ–ø—É—Å–∫–∞—Ç—å 
–ø–æ—Ç–µ—Ä—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ª—É—á—à–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å Kafka –∏–ª–∏ Redis Streams.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Redis –¥–ª—è Pub/Sub:
- `SUBSCRIBE channel` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª.
- `PUBLISH channel message` ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª.
- `UNSUBSCRIBE channel` ‚Äî –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –∫–∞–Ω–∞–ª–∞.

Redis —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è pub/sub, —É–¥–æ–±–Ω—ã–π –¥–ª—è –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã—Ö –∏ realtime-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –Ω–æ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –±—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π —Å –Ω–∞–¥–µ–∂–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä Kafka.[1][2][3][4][5]

[1](https://vk.com/@nuancesprog-podrobno-o-tehnologii-izdatel-podpischik-redis)
[2](https://selectel.ru/blog/tutorials/how-to-implement-a-queue-in-redis/)
[3](https://timeweb.cloud/tutorials/redis/broker-soobshchenij-redis)
[4](https://ru.hexlet.io/courses/redis-basics/lessons/pubsub/theory_unit)
[5](https://habr.com/ru/companies/rostelecom/articles/852362/)
[6](https://ru.hexlet.io/courses/redis-basics/lessons/message-broker/theory_unit)
[7](https://practicum.yandex.ru/blog/chto-takoe-redis-i-dlya-chego-nuzhen/)
[8](https://aws.amazon.com/ru/compare/the-difference-between-kafka-and-redis/)
[9](https://qna.habr.com/q/939653)
[10](https://academy.mediasoft.team/article/brokery-soobshenii-chto-eto-iz-chego-sostoyat-plyusy-i-minusy-sravnivaem-apache-kafka-redis-i-rabbitmq/)

---

–ö–æ–Ω–µ—á–Ω–æ, –æ—Å—Ç–∞–µ–º—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ! –≠—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –∏ –æ—á–µ–Ω—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å. **–î–∞, –¥–ª—è Redis —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏,** –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–π –Ω–∞ PgAdmin –¥–ª—è PostgreSQL.

–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis –¥–µ–ª—è—Ç—Å—è –Ω–∞ –¥–≤–µ –±–æ–ª—å—à–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: **GUI-–∫–ª–∏–µ–Ω—Ç—ã** (–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ, –∫–∞–∫ DBeaver) –∏ **CLI** (–∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞).

---

### 1. –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (GUI)

–≠—Ç–æ —Å–∞–º—ã–µ —É–¥–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏.

#### a. RedisInsight (–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ç Redis)

**–≠—Ç–æ ‚Äî –≤–∞—à "PgAdmin –¥–ª—è Redis"**. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –º–æ—â–Ω—ã–π –∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π Redis.

*   **–ß—Ç–æ —É–º–µ–µ—Ç:**
    *   –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∫–ª—é—á–∏ –≤ –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.
    *   –í–∏–¥–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –∫–ª—é—á–∞ (—Å—Ç—Ä–æ–∫–∏, —Ö–µ—à–∏, —Å–ø–∏—Å–∫–∏, sets) –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
    *   –í—ã–ø–æ–ª–Ω—è—Ç—å –ª—é–±—ã–µ –∫–æ–º–∞–Ω–¥—ã Redis –≤ –∫–æ–Ω—Å–æ–ª–∏.
    *   –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
    *   –£–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ –∏ –æ–±–ª–∞—á–Ω—ã–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ Redis.

*   **–°—Å—ã–ª–∫–∞:** [https://redis.com/redis-enterprise/redis-insight/](https://redis.com/redis-enterprise/redis-insight/)

*   **–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç:**
    ![RedisInsight Interface](https://redis.com/wp-content/uploads/2021/02/RedisInsight-2.0-Overview.png)

#### b. Another Redis Desktop Manager

–û—á–µ–Ω—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π open-source –º–µ–Ω–µ–¥–∂–µ—Ä.

*   **–ü–ª—é—Å—ã:** –û—á–µ–Ω—å –ª–µ–≥–∫–∏–π, –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π, –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.
*   **–°—Å—ã–ª–∫–∞:** [https://github.com/qishibo/AnotherRedisDesktopManager](https://github.com/qishibo/AnotherRedisDesktopManager)

#### c. Medis (—Ç–æ–ª—å–∫–æ –¥–ª—è macOS)

–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –∏ –º–æ—â–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Mac.

---

### 2. –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (CLI)

–≠—Ç–æ "—Ä–æ–¥–Ω–æ–π" —Å–ø–æ—Å–æ–± –æ–±—â–µ–Ω–∏—è —Å Redis. –ï—Å–ª–∏ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å Docker –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –æ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π.

#### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

–î–æ–ø—É—Å—Ç–∏–º, –º—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏ –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ –Ω–∞—à –∫–æ–¥ –ø–æ —à–∞–±–ª–æ–Ω—É `processed_event:some-uuid-here`.

1.  **–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis:** –ß–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Docker.
    ```bash
    # –ï—Å–ª–∏ Redis –∑–∞–ø—É—â–µ–Ω –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å –∏–º–µ–Ω–µ–º 'my-redis'
    docker exec -it my-redis redis-cli
    ```
    –ò–ª–∏ –µ—Å–ª–∏ Redis —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ/–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
    ```bash
    redis-cli -h <hostname> -p <port> -a <password>
    ```

2.  **–ù–∞–π—Ç–∏ –≤—Å–µ –∫–ª—é—á–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ —à–∞–±–ª–æ–Ω:**
    ```bash
    # –ö–æ–º–∞–Ω–¥–∞ SCAN –∏–ª–∏ KEYS (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å KEYS –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!)
    127.0.0.1:6379> SCAN 0 MATCH "processed_event:*"
    ```
    **–í–Ω–∏–º–∞–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ `KEYS "processed_event:*"` –Ω–∞ –±–æ–ª—å—à–æ–π –±–∞–∑–µ –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SCAN`.

3.  **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ –µ–≥–æ TTL:**
    ```bash
    # –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ (–¥–ª—è —Ç–∏–ø–∞ String)
    127.0.0.1:6379> GET "processed_event:123e4567-e89b-12d3-a456-426614174000"
    > "processed" # –ò–º–µ–Ω–Ω–æ —Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ, —á—Ç–æ –º—ã –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏ –≤ –∫–æ–¥–µ –Ω–∞ Kotlin

    # –£–∑–Ω–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å –∂–∏—Ç—å –∫–ª—é—á—É (TTL)
    127.0.0.1:6379> TTL "processed_event:123e4567-e89b-12d3-a456-426614174000"
    > (integer) 3540 # –û—Å—Ç–∞–ª–æ—Å—å 3540 —Å–µ–∫—É–Ω–¥ (~59 –º–∏–Ω—É—Ç)

    # –ï—Å–ª–∏ TTL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç -1 ‚Äî —É –∫–ª—é—á–∞ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ (–∂–∏–≤–µ—Ç –≤–µ—á–Ω–æ).
    # –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç -2 ‚Äî –∫–ª—é—á —É–∂–µ —É–¥–∞–ª–µ–Ω (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).
    ```

4.  **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–ª—é—á–∏ (—Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!):**
    ```bash
    # –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –º–∞–ª–µ–Ω—å–∫–∏—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö!
    127.0.0.1:6379> KEYS *
    1) "processed_event:123e4567-e89b-12d3-a456-426614174000"
    2) "processed_event:another-uuid-here"
    3) "some_other_key"
    ```

---

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ß—Ç–æ –º—ã —É–≤–∏–¥–∏–º –¥–ª—è –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞?

–í—Å–ø–æ–º–Ω–∏–º –Ω–∞—à –∫–æ–¥:
```kotlin
val wasSet = redisTemplate.opsForValue().setIfAbsent(redisKey, "processed")
```

–ü–æ—Å–ª–µ –µ–≥–æ —Ä–∞–±–æ—Ç—ã –¥–ª—è `eventId = "abc123"` –≤ Redis –º—ã —Å–º–æ–∂–µ–º –Ω–∞–π—Ç–∏:

```bash
# –í RedisInsight –∏–ª–∏ Another Redis Desktop Manager:
# –ú—ã —É–≤–∏–¥–∏–º –∫–ª—é—á —Å –∏–º–µ–Ω–µ–º `processed_event:abc123` –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º `"processed"`.

# –ß–µ—Ä–µ–∑ CLI:
127.0.0.1:6379> GET "processed_event:abc123"
"processed"

127.0.0.1:6379> TTL "processed_event:abc123"
(integer) 3562  # –ö–ª—é—á —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∏—Ç—Å—è —á–µ—Ä–µ–∑ ~59 –º–∏–Ω—É—Ç.
```

### –ò—Ç–æ–≥ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

–ï—Å–ª–∏ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ —Å–ø—Ä–æ—Å—è—Ç –ø—Ä–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis, –º–æ–∂–Ω–æ –±–ª–µ—Å–Ω—É—Ç—å –∑–Ω–∞–Ω–∏—è–º–∏:

**"–î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Redis, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –æ—Ç–ª–∞–¥–∫–µ, —è –∏—Å–ø–æ–ª—å–∑—É—é GUI-–∫–ª–∏–µ–Ω—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π RedisInsight –∏–ª–∏ Another Redis Desktop Manager. –û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–ª—é—á–∏, –∏—Ö TTL –∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ DBeaver –¥–ª—è PostgreSQL. –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —è –∏—Å–ø–æ–ª—å–∑—É—é –∫–æ–Ω—Å–æ–ª—å–Ω—É—é —É—Ç–∏–ª–∏—Ç—É `redis-cli` —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ `SCAN`, `GET` –∏ `TTL`, –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω—è –æ —Ç–æ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É `KEYS *` –Ω–µ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ production-–∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö –∏–∑-–∑–∞ –µ–µ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –ø—Ä–∏—Ä–æ–¥—ã."**

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –≤—ã –Ω–µ —Ç–æ–ª—å–∫–æ —É–º–µ–µ—Ç–µ –ø–∏—Å–∞—Ç—å –∫–æ–¥, –Ω–æ –∏ –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏.

---






