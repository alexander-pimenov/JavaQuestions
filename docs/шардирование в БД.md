# Что такое шардирование в базах данных?
![Shards Original Table](./Shards%20-%20Original%20Table.png "Original Table")
![Shards Vertical Shards](./Shards%20-%20Vertical%20Shards%20-%20VS1,%20VS2%20Table.png "Vertical Shards")
![Shards Horizontal Shards](./Shards%20-%20Horizontal%20Shards%20-%20HS1,%20HS2%20Table.png "Horizontal Shards")
- Шардирование — это способ горизонтального масштабирования, при котором данные одной базы разбиваются на 
  части (шарды) и хранятся на разных серверах или узлах.
- Шардинг — это метод оптимизации систем управления базами данных путем разделения строк или столбцов большой таблицы базы данных на несколько 
  таблиц меньшего размера.
- При шардинге базы данных создаются новые таблицы, называемые «шардами» (или разделами). Каждая новая таблица либо имеет ту же схему, 
  но уникальные строки (как в случае горизонтального шардинга - `Horizontal Shards`), либо имеет схему, являющуюся подмножеством схемы исходной 
  таблицы (как в случае вертикального шардинга - `Vertical Shards`).
- Работает по принципу shared-nothing, где каждый шард полностью независим.
- Для шардирования выбирается ключ (например, user_id), по которому данные распределяются по шардам.
- Позволяет масштабировать систему, обрабатывать запросы параллельно, повысить доступность и устойчивость.
- В отличие от партиционирования, которое разделяет данные в пределах `одного экземпляра базы`, шардирование распределяет данные физически на разные 
  узлы.
- Шардирование — Разделяя данные на более мелкие, легко управляемые блоки и распределяя их по нескольким серверам или системам хранения, 
  шардинг позволяет крупномасштабным приложениям обрабатывать большие объёмы данных, пользовательские нагрузки и выполнять параллельные операции.
- Шардинг — это метод разделения и хранения одного логического набора данных в нескольких базах данных. Распределяя данные между несколькими 
  машинами, шардинг позволяет реализовать горизонтальное разделение, эффективно повышая производительность приложений, использующих большие базы данных.

### 3. Шардирование — это ...
- архитектурное решение, на уровне приложения и инфраструктуры, пример кода зависит от реализации, но здесь простой пример использования нескольких 
  репозиториев:

```kotlin
interface UserRepositoryShard1 : JpaRepository<User, Long> { /* подключение к shard1 */ }
interface UserRepositoryShard2 : JpaRepository<User, Long> { /* подключение к shard2 */ }

// Логика распределения данных по шардам (например, по userId)
fun getRepositoryForUser(userId: Long): JpaRepository<User, Long> {
    return if (userId % 2 == 0L) userRepositoryShard1 else userRepositoryShard2
}
```

### Шардинг — распространённая концепция в масштабируемых архитектурах баз данных. 
- Шардинг большой таблицы позволяет хранить новые фрагменты данных, называемые логическими шардами, на нескольких узлах, 
  обеспечивая горизонтальную масштабируемость и повышение производительности. После того, как логический шард хранится на другом узле, 
  он становится физическим шардом.

При запуске базы данных на одном компьютере вы рано или поздно достигнете предела вычислительных ресурсов, доступных для любых запросов, и, 
очевидно, достигнете максимального объёма данных, с которым вы можете эффективно работать. Горизонтальное масштабирование позволяет реализовать 
гибкую структуру базы данных, повышающую производительность двумя ключевыми способами:

- Благодаря массивной параллельной обработке вы можете использовать все вычислительные ресурсы кластера для каждого запроса, поскольку 
каждый узел может работать с отдельными сегментами или отдельными частями базы данных.
- Поскольку отдельные сегменты меньше логической таблицы в целом, каждому узлу приходится сканировать меньше строк при ответе на запрос.

- Горизонтальное шардирование эффективно, когда запросы, как правило, возвращают подмножество строк, часто сгруппированных вместе. Например, запросы, 
  фильтрующие данные по коротким диапазонам дат, идеально подходят для горизонтального шардирования, поскольку диапазон дат неизбежно ограничит 
  запросы только подмножеством серверов (физических или виртуальных).

- Вертикальное шардинг эффективно, когда запросы, как правило, возвращают только подмножество столбцов данных. Например, если одни запросы 
  запрашивают только имена, а другие — только адреса, то имена и адреса можно шардировать на отдельные серверы.

Кроме того, шардированные базы данных обеспечивают более высокий уровень доступности. В случае сбоя в нешардированной базе данных всё приложение 
становится непригодным к использованию. В случае шардированной базы данных неработоспособными остаются только те части приложения, которые 
полагались на отсутствующие фрагменты данных. На практике шардированные базы данных часто дополнительно смягчают последствия таких сбоев, 
реплицируя резервные копии шардов на дополнительные узлы.

### Шардинг базы данных (Sharding)
- Включает разделение базы данных на более мелкие автономные части (шарды), обычно распределенные по нескольким серверам.
- Каждый шард содержит подмножество данных и отвечает за определенные диапазоны данных или атрибуты.
- Часто используется в распределенных системах для улучшения масштабируемости и производительности.
- Требуется механизм для маршрутизации запросов и транзакций в соответствующий сегмент.

- ### Разделение базы данных (Partitioning)
- Разделяет базу данных на более мелкие логические единицы, но эти единицы не обязательно являются автономными, как сегменты.
- Разделы (Partition) могут располагаться на одном сервере или в пределах одной базы данных.
- Цель — организация данных для лучшей управляемости и производительности, часто на основе таких атрибутов, как дата, регион или ключевые диапазоны.
- Не подразумевает распределение разделов по нескольким серверам как основное требование, но это часто делается для сохранения данных в случае потери отдельных узлов.

 
Подводя итог, можно сказать, что хотя и `Sharding`, и `Partitioning` направлены на организацию данных, `Sharding` в первую очередь фокусируется 
на распределении данных по нескольким серверам для масштабируемости, хотя `Partitioning` часто делает то же самое.

## Проблемы шардинга
### Шардинг также имеет свои сложности:

- `Сложность`: Шардинг усложняет архитектуру базы данных. Он требует тщательного планирования, мониторинга и обслуживания. Кроме того, выбор правильного ключа и метода шардинга может быть непростой задачей.
- `Проблемы распределения данных`: Обеспечение равномерного распределения данных по шардам может быть сложной задачей, особенно при наличии неравномерного доступа к данным. Неправильное распределение данных может привести к дисбалансу размеров шардов.
- `Управление шардами`: Управление большим количеством шардов может стать обременительным. Создание, удаление и перебалансировка шардов требуют тщательной координации и автоматизации.
- `Согласованность данных`: Поддержание согласованности данных в нескольких сегментах — сложная задача. Распределённые транзакции и обеспечение строгой согласованности данных могут быть сложными и влиять на производительность.
- `Сложность запросов`: некоторые запросы могут охватывать несколько сегментов, что требует механизма координации для извлечения, объединения и согласованного представления данных. Сложные запросы могут влиять на производительность.
- `Единые точки отказа`: Некоторые архитектуры шардинга могут иметь единые точки отказа, особенно при шардинге на основе каталогов с централизованной службой метаданных. Обеспечение высокой доступности становится критически важным.

### Как реализовать шардинг?
Внедрение шардинга в систему управления данными включает несколько ключевых этапов:

- `Моделирование данных`: определите ключ шардинга, который представляет собой атрибут или комбинацию атрибутов, используемых для определения 
  распределения данных по шардам. Выбор ключа шардинга существенно влияет на производительность и распределение данных.
- `Создание шардов`: создание и выделение шардов, на которых будут распределены данные. Шарды могут представлять собой физические серверы, 
  виртуальные машины или контейнеры, в зависимости от архитектуры системы.
- `Миграция данных`: перенос существующих данных в шарды на основе выбранного ключа шардинга. Инструменты и скрипты для миграции данных могут 
  упростить этот процесс.
- `Маршрутизация запросов`: Разработайте механизм маршрутизации запросов, который направляет пользовательские запросы и транзакции в соответствующий 
  шард на основе ключа шардинга. Часто для этого требуется промежуточный уровень программного обеспечения, отвечающий за маршрутизацию.
- `Управление сегментами`: внедрение инструментов и процессов для управления сегментами, включая добавление или удаление сегментов, повторную 
  балансировку данных и обработку сбоев сегментов.
- `Мониторинг и обслуживание`: Внедрите процессы мониторинга и обслуживания для обеспечения работоспособности и производительности разделяемой 
  базы данных. Это включает в себя мониторинг несбалансированного размера сегментов, высоких задержек запросов и аппаратных сбоев.

### Шардинг в реальных приложениях
Шардинг широко используется в различных реальных приложениях и отраслях для решения задач масштабируемости и производительности. 
Вот несколько примечательных примеров:

- Платформы социальных сетей: компании, работающие в социальных сетях, используют технологию Sharding для управления большими объёмами пользовательского контента, такого как публикации, фотографии и видео. Sharding обеспечивает быстрый доступ к пользовательским данным и высокую доступность.
- Электронная коммерция: интернет-магазины используют шардинг для управления большими каталогами товаров и обслуживания большого трафика. Шардинг необходим для управления данными о заказах и запасами.
- Игры: Онлайн-игровые платформы используют технологию Sharding для распространения данных о состоянии игры и профилей игроков. Sharding обеспечивает минимальную задержку даже в глобально распределённых многопользовательских играх.
- Финансовые услуги: финансовые учреждения используют технологию Sharding для управления огромными объёмами данных о транзакциях, записями клиентов и финансовой историей. Sharding повышает производительность и безопасность данных.
- Сети доставки контента (CDN): CDN используют гео-ориентированное сегментирование для кэширования и эффективной доставки веб-контента пользователям по всему миру. Данные распределяются по периферийным серверам, расположенным рядом с конечными пользователями, что позволяет сократить задержки.
- Интернет вещей и телеметрия: платформы Интернета вещей (IoT) используют шардинг для управления огромным потоком данных, генерируемых датчиками и устройствами. Шардинг помогает обрабатывать и анализировать телеметрические данные в режиме реального времени.

 
### Заключение
Шардинг может быть реализован на основе диапазона, хэш-функции, на основе каталогов и геолокации, крайне важно для выбора наиболее подходящего подхода 
для конкретного приложения. Хотя шардинг предлагает множество преимуществ, он также создаёт сложности и проблемы, требующие тщательного планирования, 
мониторинга и управления. При эффективном внедрении шардинг становится ключевым фактором создания высокопроизводительных распределённых систем в 
цифровую эпоху.

---


[9](https://aws.amazon.com/what-is/database-sharding/)
[10](https://www.youtube.com/watch?v=XP98YCr-iXQ)
[11](https://hazelcast.com/foundations/distributed-computing/sharding/)